"use strict";
/*!
 *  omix v2.3.2 by dntzhang
 *  Github: https://github.com/Tencent/omi
 *  MIT Licensed.
*/
Object.defineProperty(exports, "__esModule", { value: true });
var obaa_1 = require("./obaa");
var path_1 = require("./path");
function create(store, option) {
    if (arguments.length === 2) {
        if (!store.instances) {
            store.instances = {};
        }
        if (!store.__changes_) {
            store.__changes_ = [];
        }
        var changes_1 = store.__changes_;
        if (!store.onChange) {
            store.onChange = function (fn) {
                changes_1.push(fn);
            };
        }
        if (!store.offChange) {
            store.offChange = function (fn) {
                for (var i = 0, len = changes_1.length; i < len; i++) {
                    if (changes_1[i] === fn) {
                        changes_1.splice(i, 1);
                        break;
                    }
                }
            };
        }
        var hasData_1 = typeof option.data !== 'undefined';
        var clone_1;
        if (option.data) {
            clone_1 = JSON.parse(JSON.stringify(option.data));
            option.data.$ = store.data;
        }
        else {
            option.data = store.data;
        }
        observeStore(store);
        var onLoad_1 = option.onLoad;
        option.onLoad = function (e) {
            this.store = store;
            option.use && (this.__updatePath = path_1.getPath(option.use));
            this.__use = option.use;
            this.__hasData = hasData_1;
            if (hasData_1) {
                Object.assign(option.data, JSON.parse(JSON.stringify(clone_1)));
            }
            store.instances[this.route] = [];
            store.instances[this.route].push(this);
            this.computed = option.computed;
            this.setData(option.data);
            var using = path_1.getUsing(store.data, option.use);
            option.computed && compute(option.computed, store, using, this);
            this.setData(using);
            onLoad_1 && onLoad_1.call(this, e);
        };
        Page(option);
    }
    else {
        var ready_1 = (store.lifetimes && store.lifetimes.ready) || store.ready;
        store.lifetimes = store.lifetimes || {};
        store.ready = store.lifetimes.ready = function () {
            var page = getCurrentPages()[getCurrentPages().length - 1];
            store.use && (this.__updatePath = path_1.getPath(store.use));
            this.store = page.store;
            this.__use = store.use;
            this.computed = store.computed;
            store.data = this.store.data;
            this.setData(store.data);
            var using = path_1.getUsing(this.store.data, store.use);
            store.computed && compute(store.computed, this.store, using, this);
            this.setData(using);
            this.store.instances[page.route].push(this);
            ready_1 && ready_1.call(this);
        };
        Component(store);
    }
}
function compute(computed, store, using, scope) {
    for (var key in computed) {
        using[key] = computed[key].call(store.data, scope);
    }
}
function observeStore(store) {
    var oba = obaa_1.default(store.data, function (prop, value, old, path) {
        var patch = {};
        if (prop.indexOf('Array-push') === 0) {
            var dl = value.length - old.length;
            for (var i = 0; i < dl; i++) {
                patch[path_1.fixPath(path + '-' + (old.length + i))] = value[(old.length + i)];
            }
        }
        else if (prop.indexOf('Array-') === 0) {
            patch[path_1.fixPath(path)] = value;
        }
        else {
            patch[path_1.fixPath(path + '-' + prop)] = value;
        }
        _update(patch, store);
    });
    if (!store.set) {
        store.set = function (obj, prop, val) {
            obaa_1.default.set(obj, prop, val, oba);
        };
    }
}
function _update(kv, store) {
    for (var key in store.instances) {
        store.instances[key].forEach(function (ins) {
            if (store.updateAll || ins.__updatePath && path_1.needUpdate(kv, ins.__updatePath)) {
                if (ins.__hasData) {
                    for (var pk in kv) {
                        kv['$.' + pk] = kv[pk];
                        delete kv[pk];
                    }
                    ins.setData.call(ins, kv);
                }
                else {
                    ins.setData.call(ins, kv);
                }
                var using = path_1.getUsing(store.data, ins.__use);
                compute(ins.computed, store, using, ins);
                ins.setData(using);
            }
        });
    }
    store.__changes_.forEach(function (change) {
        change(kv);
    });
    store.debug && storeChangeLogger(store, kv);
}
function storeChangeLogger(store, diffResult) {
    try {
        var preState = wx.getStorageSync("CurrentState") || {};
        var title = "Data Changed";
        console.groupCollapsed("%c  " + title + " %c " + Object.keys(diffResult), 'color:#e0c184; font-weight: bold', 'color:#f0a139; font-weight: bold');
        console.log("%c    Pre Data", 'color:#ff65af; font-weight: bold', preState);
        console.log("%c Change Data", 'color:#3d91cf; font-weight: bold', diffResult);
        console.log("%c   Next Data", 'color:#2c9f67; font-weight: bold', store.data);
        console.groupEnd();
        wx.setStorageSync("CurrentState", store.data);
    }
    catch (e) {
        console.log(e);
    }
}
create.obaa = obaa_1.default;
exports.default = create;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztFQUlFOztBQUVGLCtCQUF5QjtBQUN6QiwrQkFBK0Q7QUE4Si9ELFNBQVMsTUFBTSxDQUFDLEtBQTRCLEVBQUUsTUFBbUI7SUFDL0QsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNwQixLQUFLLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtTQUNyQjtRQUVELElBQUcsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFDO1lBQ25CLEtBQUssQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFBO1NBQ3RCO1FBRUQsSUFBTSxTQUFPLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtZQUNuQixLQUFLLENBQUMsUUFBUSxHQUFHLFVBQVUsRUFBdUI7Z0JBQ2hELFNBQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDbEIsQ0FBQyxDQUFBO1NBQ0Y7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNwQixLQUFLLENBQUMsU0FBUyxHQUFHLFVBQVUsRUFBdUI7Z0JBQ2pELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxTQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2xELElBQUksU0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTt3QkFDckIsU0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7d0JBQ3BCLE1BQUs7cUJBQ047aUJBQ0Y7WUFDSCxDQUFDLENBQUE7U0FDRjtRQUVELElBQU0sU0FBTyxHQUFHLE9BQU8sTUFBTSxDQUFDLElB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QUFNLFFBQVEsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtRQUN4RCxJQUFNLEtBQUssR0FBRyxjQUFjLENBQUE7UUFDNUIsT0FBTyxDQUFDLGNBQWMsQ0FBQyxTQUFPLEtBQUssWUFBTyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBRyxFQUFFLGtDQUFrQyxFQUFFLGtDQUFrQyxDQUFDLENBQUE7UUFDNUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxrQ0FBa0MsRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUMzRSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLGtDQUFrQyxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQzdFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsa0NBQWtDLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzdFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUNsQixFQUFFLENBQUMsY0FBYyxDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDOUM7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDZjtBQUVILENBQUM7QUFFRCxNQUFNLENBQUMsSUFBSSxHQUFHLGNBQUksQ0FBQTtBQUdsQixrQkFBZSxNQUFNLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqICBvbWl4IHYyLjMuMiBieSBkbnR6aGFuZ1xuICogIEdpdGh1YjogaHR0cHM6Ly9naXRodWIuY29tL1RlbmNlbnQvb21pXG4gKiAgTUlUIExpY2Vuc2VkLlxuKi9cblxuaW1wb3J0IG9iYWEgZnJvbSAnLi9vYmFhJ1xuaW1wb3J0IHsgZ2V0UGF0aCwgbmVlZFVwZGF0ZSwgZml4UGF0aCwgZ2V0VXNpbmcgfSBmcm9tICcuL3BhdGgnXG5cblxuaW50ZXJmYWNlIFN0b3JlQ2hhbmdlQ2FsbGJhY2sge1xuICAoZGV0YWlsOiBhbnkpOiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVBhZ2VTY3JvbGxPcHRpb24ge1xuICAvKiog6aG16Z2i5Zyo5Z6C55u05pa55ZCR5bey5rua5Yqo55qE6Led56a777yI5Y2V5L2NcHjvvIkgKi9cbiAgc2Nyb2xsVG9wOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBJVGFiSXRlbVRhcE9wdGlvbiB7XG4gIC8qKiDooqvngrnlh7t0YWJJdGVt55qE5bqP5Y+377yM5LuOMOW8gOWni++8jOacgOS9juWfuuehgOW6k++8miBgMS45LjBgICovXG4gIGluZGV4OiBzdHJpbmc7XG4gIC8qKiDooqvngrnlh7t0YWJJdGVt55qE6aG16Z2i6Lev5b6E77yM5pyA5L2O5Z+656GA5bqT77yaIGAxLjkuMGAgKi9cbiAgcGFnZVBhdGg6IHN0cmluZztcbiAgLyoqIOiiq+eCueWHu3RhYkl0ZW3nmoTmjInpkq7mloflrZfvvIzmnIDkvY7ln7rnoYDlupPvvJogYDEuOS4wYCAqL1xuICB0ZXh0OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJU2hhcmVBcHBNZXNzYWdlT3B0aW9uIHtcbiAgLyoqIOi9rOWPkeS6i+S7tuadpea6kOOAglxuICAgKlxuICAgKiDlj6/pgInlgLzvvJpcbiAgICogLSBgYnV0dG9uYO+8mumhtemdouWGhei9rOWPkeaMiemSru+8m1xuICAgKiAtIGBtZW51YO+8muWPs+S4iuinkui9rOWPkeiPnOWNleOAglxuICAgKlxuICAgKiDmnIDkvY7ln7rnoYDlupPvvJogYDEuMi40YFxuICAgKi9cbiAgZnJvbTogJ2J1dHRvbicgfCAnbWVudScgfCBzdHJpbmc7XG4gIC8qKiDlpoLmnpwgYGZyb21gIOWAvOaYryBgYnV0dG9uYO+8jOWImSBgdGFyZ2V0YCDmmK/op6blj5Hov5nmrKHovazlj5Hkuovku7bnmoQgYGJ1dHRvbmDvvIzlkKbliJnkuLogYHVuZGVmaW5lZGBcbiAgICpcbiAgICog5pyA5L2O5Z+656GA5bqT77yaIGAxLjIuNGAgKi9cbiAgdGFyZ2V0OiBhbnk7XG4gIC8qKiDpobXpnaLkuK3ljIXlkKtgPHdlYi12aWV3PmDnu4Tku7bml7bvvIzov5Tlm57lvZPliY1gPHdlYi12aWV3PmDnmoR1cmxcbiAgICpcbiAgICog5pyA5L2O5Z+656GA5bqT77yaIGAxLjYuNGBcbiAgICovXG4gIHdlYlZpZXdVcmw/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJQ3VzdG9tU2hhcmVDb250ZW50IHtcbiAgLyoqIOi9rOWPkeagh+mimOOAgum7mOiupOWAvO+8muW9k+WJjeWwj+eoi+W6j+WQjeensCAqL1xuICB0aXRsZT86IHN0cmluZztcbiAgLyoqIOi9rOWPkei3r+W+hO+8jOW/hemhu+aYr+S7pSAvIOW8gOWktOeahOWujOaVtOi3r+W+hOOAgum7mOiupOWAvO+8muW9k+WJjemhtemdoiBwYXRoICovXG4gIHBhdGg/OiBzdHJpbmc7XG4gIC8qKiDoh6rlrprkuYnlm77niYfot6/lvoTvvIzlj6/ku6XmmK/mnKzlnLDmlofku7bot6/lvoTjgIHku6PnoIHljIXmlofku7bot6/lvoTmiJbogIXnvZHnu5zlm77niYfot6/lvoTjgILmlK/mjIFQTkflj4pKUEfjgILmmL7npLrlm77niYfplb/lrr3mr5TmmK8gNTo077yM5pyA5L2O5Z+656GA5bqT77yaIGAxLjUuMGDjgILpu5jorqTlgLzvvJrkvb/nlKjpu5jorqTmiKrlm74gKi9cbiAgaW1hZ2VVcmw/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBDb21wb25lbnRPcHRpb24ge1xuICBba2V5OiBzdHJpbmddOiBhbnlcbn1cblxuaW50ZXJmYWNlIENvbXB1dGVkIHtcbiAgW2tleTogc3RyaW5nXTogYW55XG59XG5cbmludGVyZmFjZSBQYWdlT3B0aW9uIHtcbiAgICBba2V5OiBzdHJpbmddOiBhbnksXG4gICAgLyoqXG4gICAgICog5L6d6LWWIHN0b3JlIOS4iueahCBwYXRoXG4gICAgICovXG4gICAgdXNlPzogQXJyYXk8c3RyaW5nIHwgb2JqZWN0PlxuICAgIC8qKlxuICAgICAqIOiuoeeul+WxnuaAp1xuICAgICAqL1xuICAgIGNvbXB1dGVkPzogQ29tcHV0ZWQsXG4gICAgLyoqIOeUn+WRveWRqOacn+Wbnuiwg+KAlOebkeWQrOmhtemdouWKoOi9vVxuICAgICAqXG4gICAgICog6aG16Z2i5Yqg6L295pe26Kem5Y+R44CC5LiA5Liq6aG16Z2i5Y+q5Lya6LCD55So5LiA5qyh77yM5Y+v5Lul5ZyoIG9uTG9hZCDnmoTlj4LmlbDkuK3ojrflj5bmiZPlvIDlvZPliY3pobXpnaLot6/lvoTkuK3nmoTlj4LmlbDjgIJcbiAgICAgKi9cbiAgICBvbkxvYWQ/KFxuICAgICAgLyoqIOaJk+W8gOW9k+WJjemhtemdoui3r+W+hOS4reeahOWPguaVsCAqL1xuICAgICAgcXVlcnk/OiB7IFtxdWVyeUtleTogc3RyaW5nXTogc3RyaW5nIH0sXG4gICAgKTogdm9pZDtcbiAgICAvKiog55Sf5ZG95ZGo5pyf5Zue6LCD4oCU55uR5ZCs6aG16Z2i5pi+56S6XG4gICAgICpcbiAgICAgKiDpobXpnaLmmL7npLov5YiH5YWl5YmN5Y+w5pe26Kem5Y+R44CCXG4gICAgICovXG4gICAgb25TaG93PygpOiB2b2lkO1xuICAgIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLliJ3mrKHmuLLmn5PlrozmiJBcbiAgICAgKlxuICAgICAqIOmhtemdouWIneasoea4suafk+WujOaIkOaXtuinpuWPkeOAguS4gOS4qumhtemdouWPquS8muiwg+eUqOS4gOasoe+8jOS7o+ihqOmhtemdouW3sue7j+WHhuWkh+WmpeW9k++8jOWPr+S7peWSjOinhuWbvuWxgui/m+ihjOS6pOS6kuOAglxuICAgICAqXG5cbiAgICAgKiDms6jmhI/vvJrlr7nnlYzpnaLlhoXlrrnov5vooYzorr7nva7nmoQgQVBJIOWmgmB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGVg77yM6K+35ZyoYG9uUmVhZHlg5LmL5ZCO6L+b6KGM44CCXG4gICAgKi9cbiAgICBvblJlYWR5PygpOiB2b2lkO1xuICAgIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLpmpDol49cbiAgICAgKlxuICAgICAqIOmhtemdoumakOiXjy/liIflhaXlkI7lj7Dml7bop6blj5HjgIIg5aaCIGBuYXZpZ2F0ZVRvYCDmiJblupXpg6ggYHRhYmAg5YiH5o2i5Yiw5YW25LuW6aG16Z2i77yM5bCP56iL5bqP5YiH5YWl5ZCO5Y+w562J44CCXG4gICAgICovXG4gICAgb25IaWRlPygpOiB2b2lkO1xuICAgIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLljbjovb1cbiAgICAgKlxuICAgICAqIOmhtemdouWNuOi9veaXtuinpuWPkeOAguWmgmByZWRpcmVjdFRvYOaIlmBuYXZpZ2F0ZUJhY2tg5Yiw5YW25LuW6aG16Z2i5pe244CCXG4gICAgICovXG4gICAgb25VbmxvYWQ/KCk6IHZvaWQ7XG4gICAgLyoqIOebkeWQrOeUqOaIt+S4i+aLieWKqOS9nFxuICAgICAqXG4gICAgICog55uR5ZCs55So5oi35LiL5ouJ5Yi35paw5LqL5Lu244CCXG4gICAgICogLSDpnIDopoHlnKhgYXBwLmpzb25g55qEYHdpbmRvd2DpgInpobnkuK3miJbpobXpnaLphY3nva7kuK3lvIDlkK9gZW5hYmxlUHVsbERvd25SZWZyZXNoYOOAglxuICAgICAqIC0g5Y+v5Lul6YCa6L+HYHd4LnN0YXJ0UHVsbERvd25SZWZyZXNoYOinpuWPkeS4i+aLieWIt+aWsO+8jOiwg+eUqOWQjuinpuWPkeS4i+aLieWIt+aWsOWKqOeUu++8jOaViOaenOS4jueUqOaIt+aJi+WKqOS4i+aLieWIt+aWsOS4gOiHtOOAglxuICAgICAqIC0g5b2T5aSE55CG5a6M5pWw5o2u5Yi35paw5ZCO77yMYHd4LnN0b3BQdWxsRG93blJlZnJlc2hg5Y+v5Lul5YGc5q2i5b2T5YmN6aG16Z2i55qE5LiL5ouJ5Yi35paw44CCXG4gICAgICovXG4gICAgb25QdWxsRG93blJlZnJlc2g/KCk6IHZvaWQ7XG4gICAgLyoqIOmhtemdouS4iuaLieinpuW6leS6i+S7tueahOWkhOeQhuWHveaVsFxuICAgICAqXG4gICAgICog55uR5ZCs55So5oi35LiK5ouJ6Kem5bqV5LqL5Lu244CCXG4gICAgICogLSDlj6/ku6XlnKhgYXBwLmpzb25g55qEYHdpbmRvd2DpgInpobnkuK3miJbpobXpnaLphY3nva7kuK3orr7nva7op6blj5Hot53nprtgb25SZWFjaEJvdHRvbURpc3RhbmNlYOOAglxuICAgICAqIC0g5Zyo6Kem5Y+R6Led56a75YaF5ruR5Yqo5pyf6Ze077yM5pys5LqL5Lu25Y+q5Lya6KKr6Kem5Y+R5LiA5qyh44CCXG4gICAgICovXG4gICAgb25SZWFjaEJvdHRvbT8oKTogdm9pZDtcbiAgICAvKiog55So5oi354K55Ye75Y+z5LiK6KeS6L2s5Y+RXG4gICAgICpcbiAgICAgKiDnm5HlkKznlKjmiLfngrnlh7vpobXpnaLlhoXovazlj5HmjInpkq7vvIhgPGJ1dHRvbj5gIOe7hOS7tiBgb3Blbi10eXBlPVwic2hhcmVcImDvvInmiJblj7PkuIrop5Loj5zljZXigJzovazlj5HigJ3mjInpkq7nmoTooYzkuLrvvIzlubboh6rlrprkuYnovazlj5HlhoXlrrnjgIJcbiAgICAgKlxuICAgICAqICoq5rOo5oSP77ya5Y+q5pyJ5a6a5LmJ5LqG5q2k5LqL5Lu25aSE55CG5Ye95pWw77yM5Y+z5LiK6KeS6I+c5Y2V5omN5Lya5pi+56S64oCc6L2s5Y+R4oCd5oyJ6ZKuKipcbiAgICAgKlxuICAgICAqIOatpOS6i+S7tumcgOimgSByZXR1cm4g5LiA5LiqIE9iamVjdO+8jOeUqOS6juiHquWumuS5iei9rOWPkeWGheWuuVxuICAgICAqL1xuICAgIG9uU2hhcmVBcHBNZXNzYWdlPyhcbiAgICAgIC8qKiDliIbkuqvlj5HotbfmnaXmupDlj4LmlbAgKi9cbiAgICAgIG9wdGlvbnM/OiBJU2hhcmVBcHBNZXNzYWdlT3B0aW9uLFxuICAgICk6IElDdXN0b21TaGFyZUNvbnRlbnQ7XG4gICAgLyoqIOmhtemdoua7muWKqOinpuWPkeS6i+S7tueahOWkhOeQhuWHveaVsFxuICAgICAqXG4gICAgICog55uR5ZCs55So5oi35ruR5Yqo6aG16Z2i5LqL5Lu244CCXG4gICAgICovXG4gICAgb25QYWdlU2Nyb2xsPyhcbiAgICAgIC8qKiDpobXpnaLmu5rliqjlj4LmlbAgKi9cbiAgICAgIG9wdGlvbnM/OiBJUGFnZVNjcm9sbE9wdGlvbixcbiAgICApOiB2b2lkO1xuXG4gICAgLyoqIOW9k+WJjeaYryB0YWIg6aG15pe277yM54K55Ye7IHRhYiDml7bop6blj5HvvIzmnIDkvY7ln7rnoYDlupPvvJogYDEuOS4wYCAqL1xuICAgIG9uVGFiSXRlbVRhcD8oXG4gICAgICAvKiogdGFiIOeCueWHu+WPguaVsCAqL1xuICAgICAgb3B0aW9ucz86IElUYWJJdGVtVGFwT3B0aW9uLFxuICAgICk6IHZvaWQ7XG5cbiAgICAvKiog56qX5Y+j5bC65a+45pS55Y+Y5pe26Kem5Y+R77yM5pyA5L2O5Z+656GA5bqT77yaYDIuNC4wYCAqL1xuICAgIG9uUmVzaXplPyhcbiAgICAgIC8qKiDnqpflj6PlsLrlr7jlj4LmlbAgKi9cbiAgICAgIG9wdGlvbnM/OiBJUmVzaXplT3B0aW9uLFxuICAgICk6IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJUmVzaXplT3B0aW9uIHtcbiAgc2l6ZToge1xuICAgIC8qKiDlj5jljJblkI7nmoTnqpflj6Plrr3luqbvvIzljZXkvY0gcHggKi9cbiAgICB3aW5kb3dXaWR0aDogbnVtYmVyO1xuICAgIC8qKiDlj5jljJblkI7nmoTnqpflj6Ppq5jluqbvvIzljZXkvY0gcHggKi9cbiAgICB3aW5kb3dIZWlnaHQ6IG51bWJlcjtcbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlKHN0b3JlOiBhbnkgfCBDb21wb25lbnRPcHRpb24sIG9wdGlvbj86IFBhZ2VPcHRpb24pIHtcbiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHtcbiAgICBpZiAoIXN0b3JlLmluc3RhbmNlcykge1xuICAgICAgc3RvcmUuaW5zdGFuY2VzID0ge31cbiAgICB9XG5cbiAgICBpZighc3RvcmUuX19jaGFuZ2VzXyl7XG4gICAgICBzdG9yZS5fX2NoYW5nZXNfID0gW11cbiAgICB9XG5cbiAgICBjb25zdCBjaGFuZ2VzID0gc3RvcmUuX19jaGFuZ2VzX1xuICAgIGlmICghc3RvcmUub25DaGFuZ2UpIHtcbiAgICAgIHN0b3JlLm9uQ2hhbmdlID0gZnVuY3Rpb24gKGZuOiBTdG9yZUNoYW5nZUNhbGxiYWNrKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaChmbilcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXN0b3JlLm9mZkNoYW5nZSkge1xuICAgICAgc3RvcmUub2ZmQ2hhbmdlID0gZnVuY3Rpb24gKGZuOiBTdG9yZUNoYW5nZUNhbGxiYWNrKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgaWYgKGNoYW5nZXNbaV0gPT09IGZuKSB7XG4gICAgICAgICAgICBjaGFuZ2VzLnNwbGljZShpLCAxKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBoYXNEYXRhID0gdHlwZW9mIG9wdGlvbi5kYXRhICE9PSAndW5kZWZpbmVkJ1xuICAgIGxldCBjbG9uZVxuICAgIGlmIChvcHRpb24uZGF0YSkge1xuICAgICAgY2xvbmUgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9wdGlvbi5kYXRhKSlcbiAgICAgIG9wdGlvbi5kYXRhLiQgPSBzdG9yZS5kYXRhXG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdGlvbi5kYXRhID0gc3RvcmUuZGF0YVxuICAgIH1cbiAgICBvYnNlcnZlU3RvcmUoc3RvcmUpXG4gICAgY29uc3Qgb25Mb2FkID0gb3B0aW9uLm9uTG9hZFxuXG4gICAgb3B0aW9uLm9uTG9hZCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICB0aGlzLnN0b3JlID0gc3RvcmVcblxuICAgICAgb3B0aW9uLnVzZSAmJiAodGhpcy5fX3VwZGF0ZVBhdGggPSBnZXRQYXRoKG9wdGlvbi51c2UpKVxuICAgICAgdGhpcy5fX3VzZSA9IG9wdGlvbi51c2VcbiAgICAgIHRoaXMuX19oYXNEYXRhID0gaGFzRGF0YVxuICAgICAgaWYoaGFzRGF0YSl7XG4gICAgICAgIE9iamVjdC5hc3NpZ24ob3B0aW9uLmRhdGEsIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY2xvbmUpKSlcbiAgICAgIH1cbiAgICAgIHN0b3JlLmluc3RhbmNlc1t0aGlzLnJvdXRlXSA9IFtdXG4gICAgICBzdG9yZS5pbnN0YW5jZXNbdGhpcy5yb3V0ZV0ucHVzaCh0aGlzKVxuICAgICAgdGhpcy5jb21wdXRlZCA9IG9wdGlvbi5jb21wdXRlZFxuICAgICAgdGhpcy5zZXREYXRhKG9wdGlvbi5kYXRhKVxuICAgICAgY29uc3QgdXNpbmcgPSBnZXRVc2luZyhzdG9yZS5kYXRhLCBvcHRpb24udXNlKVxuXG4gICAgICBvcHRpb24uY29tcHV0ZWQgJiYgY29tcHV0ZShvcHRpb24uY29tcHV0ZWQsIHN0b3JlLCB1c2luZywgdGhpcylcbiAgICAgIHRoaXMuc2V0RGF0YSh1c2luZylcblxuICAgICAgb25Mb2FkICYmIG9uTG9hZC5jYWxsKHRoaXMsIGUpXG4gICAgfVxuICAgIFBhZ2Uob3B0aW9uKVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IHJlYWR5ID0gKHN0b3JlLmxpZmV0aW1lcyAmJiBzdG9yZS5saWZldGltZXMucmVhZHkpIHx8IHN0b3JlLnJlYWR5XG4gICAgc3RvcmUubGlmZXRpbWVzID0gc3RvcmUubGlmZXRpbWVzIHx8IHt9XG4gICAgc3RvcmUucmVhZHkgPSBzdG9yZS5saWZldGltZXMucmVhZHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBwYWdlID0gZ2V0Q3VycmVudFBhZ2VzKClbZ2V0Q3VycmVudFBhZ2VzKCkubGVuZ3RoIC0gMV1cbiAgICAgIHN0b3JlLnVzZSAmJiAodGhpcy5fX3VwZGF0ZVBhdGggPSBnZXRQYXRoKHN0b3JlLnVzZSkpXG4gICAgICB0aGlzLnN0b3JlID0gcGFnZS5zdG9yZVxuICAgICAgdGhpcy5fX3VzZSA9IHN0b3JlLnVzZVxuICAgICAgdGhpcy5jb21wdXRlZCA9IHN0b3JlLmNvbXB1dGVkXG4gICAgICBzdG9yZS5kYXRhID0gdGhpcy5zdG9yZS5kYXRhXG4gICAgICB0aGlzLnNldERhdGEoc3RvcmUuZGF0YSlcbiAgICAgIGNvbnN0IHVzaW5nID0gZ2V0VXNpbmcodGhpcy5zdG9yZS5kYXRhLCBzdG9yZS51c2UpXG5cbiAgICAgIHN0b3JlLmNvbXB1dGVkICYmIGNvbXB1dGUoc3RvcmUuY29tcHV0ZWQsIHRoaXMuc3RvcmUsIHVzaW5nLCB0aGlzKVxuICAgICAgdGhpcy5zZXREYXRhKHVzaW5nKVxuXG4gICAgICB0aGlzLnN0b3JlLmluc3RhbmNlc1twYWdlLnJvdXRlXS5wdXNoKHRoaXMpXG4gICAgICByZWFkeSAmJiByZWFkeS5jYWxsKHRoaXMpXG4gICAgfVxuICAgIENvbXBvbmVudChzdG9yZSlcbiAgfVxufVxuXG5mdW5jdGlvbiBjb21wdXRlKGNvbXB1dGVkLCBzdG9yZSwgdXNpbmcsIHNjb3BlKSB7XG4gIGZvciAobGV0IGtleSBpbiBjb21wdXRlZCkge1xuICAgIHVzaW5nW2tleV0gPSBjb21wdXRlZFtrZXldLmNhbGwoc3RvcmUuZGF0YSwgc2NvcGUpXG4gIH1cbn1cblxuZnVuY3Rpb24gb2JzZXJ2ZVN0b3JlKHN0b3JlKSB7XG4gIGNvbnN0IG9iYSA9IG9iYWEoc3RvcmUuZGF0YSwgKHByb3AsIHZhbHVlLCBvbGQsIHBhdGgpID0+IHtcbiAgICBsZXQgcGF0Y2ggPSB7fVxuICAgIGlmIChwcm9wLmluZGV4T2YoJ0FycmF5LXB1c2gnKSA9PT0gMCkge1xuICAgICAgbGV0IGRsID0gdmFsdWUubGVuZ3RoIC0gb2xkLmxlbmd0aFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkbDsgaSsrKSB7XG4gICAgICAgIHBhdGNoW2ZpeFBhdGgocGF0aCArICctJyArIChvbGQubGVuZ3RoICsgaSkpXSA9IHZhbHVlWyhvbGQubGVuZ3RoICsgaSldXG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm9wLmluZGV4T2YoJ0FycmF5LScpID09PSAwKSB7XG4gICAgICBwYXRjaFtmaXhQYXRoKHBhdGgpXSA9IHZhbHVlXG4gICAgfSBlbHNlIHtcbiAgICAgIHBhdGNoW2ZpeFBhdGgocGF0aCArICctJyArIHByb3ApXSA9IHZhbHVlXG4gICAgfVxuXG4gICAgX3VwZGF0ZShwYXRjaCwgc3RvcmUpXG5cblxuICB9KVxuXG4gIGlmKCFzdG9yZS5zZXQpIHtcbiAgICBzdG9yZS5zZXQgPSBmdW5jdGlvbiAob2JqLCBwcm9wLCB2YWwpIHtcbiAgICAgIG9iYWEuc2V0KG9iaiwgcHJvcCwgdmFsLCBvYmEpXG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIF91cGRhdGUoa3YsIHN0b3JlKSB7XG4gIGZvciAobGV0IGtleSBpbiBzdG9yZS5pbnN0YW5jZXMpIHtcbiAgICBzdG9yZS5pbnN0YW5jZXNba2V5XS5mb3JFYWNoKGlucyA9PiB7XG4gICAgICBpZiAoc3RvcmUudXBkYXRlQWxsIHx8IGlucy5fX3VwZGF0ZVBhdGggJiYgbmVlZFVwZGF0ZShrdiwgaW5zLl9fdXBkYXRlUGF0aCkpIHtcbiAgICAgICAgaWYgKGlucy5fX2hhc0RhdGEpIHtcbiAgICAgICAgICBmb3IgKGxldCBwayBpbiBrdikge1xuICAgICAgICAgICAga3ZbJyQuJyArIHBrXSA9IGt2W3BrXVxuICAgICAgICAgICAgZGVsZXRlIGt2W3BrXVxuICAgICAgICAgIH1cbiAgICAgICAgICBpbnMuc2V0RGF0YS5jYWxsKGlucywga3YpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaW5zLnNldERhdGEuY2FsbChpbnMsIGt2KVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXNpbmcgPSBnZXRVc2luZyhzdG9yZS5kYXRhLCBpbnMuX191c2UpXG5cbiAgICAgICAgY29tcHV0ZShpbnMuY29tcHV0ZWQsIHN0b3JlLCB1c2luZywgaW5zKVxuICAgICAgICBpbnMuc2V0RGF0YSh1c2luZylcblxuXG4gICAgICB9XG4gICAgfSlcbiAgfVxuICBzdG9yZS5fX2NoYW5nZXNfLmZvckVhY2goY2hhbmdlID0+IHtcbiAgICBjaGFuZ2Uoa3YpXG4gIH0pXG4gIHN0b3JlLmRlYnVnICYmIHN0b3JlQ2hhbmdlTG9nZ2VyKHN0b3JlLCBrdilcbn1cblxuZnVuY3Rpb24gc3RvcmVDaGFuZ2VMb2dnZXIoc3RvcmUsIGRpZmZSZXN1bHQpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwcmVTdGF0ZSA9IHd4LmdldFN0b3JhZ2VTeW5jKGBDdXJyZW50U3RhdGVgKSB8fCB7fVxuICAgIGNvbnN0IHRpdGxlID0gYERhdGEgQ2hhbmdlZGBcbiAgICBjb25zb2xlLmdyb3VwQ29sbGFwc2VkKGAlYyAgJHt0aXRsZX0gJWMgJHtPYmplY3Qua2V5cyhkaWZmUmVzdWx0KX1gLCAnY29sb3I6I2UwYzE4NDsgZm9udC13ZWlnaHQ6IGJvbGQnLCAnY29sb3I6I2YwYTEzOTsgZm9udC13ZWlnaHQ6IGJvbGQnKVxuICAgIGNvbnNvbGUubG9nKGAlYyAgICBQcmUgRGF0YWAsICdjb2xvcjojZmY2NWFmOyBmb250LXdlaWdodDogYm9sZCcsIHByZVN0YXRlKVxuICAgIGNvbnNvbGUubG9nKGAlYyBDaGFuZ2UgRGF0YWAsICdjb2xvcjojM2Q5MWNmOyBmb250LXdlaWdodDogYm9sZCcsIGRpZmZSZXN1bHQpXG4gICAgY29uc29sZS5sb2coYCVjICAgTmV4dCBEYXRhYCwgJ2NvbG9yOiMyYzlmNjc7IGZvbnQtd2VpZ2h0OiBib2xkJywgc3RvcmUuZGF0YSlcbiAgICBjb25zb2xlLmdyb3VwRW5kKClcbiAgICB3eC5zZXRTdG9yYWdlU3luYyhgQ3VycmVudFN0YXRlYCwgc3RvcmUuZGF0YSlcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUubG9nKGUpXG4gIH1cblxufVxuXG5jcmVhdGUub2JhYSA9IG9iYWFcblxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVcbiJdfQ==