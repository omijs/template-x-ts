"use strict";
/*!
 *  omix v2.3.4 by dntzhang
 *  Github: https://github.com/Tencent/omi
 *  MIT Licensed.
*/
Object.defineProperty(exports, "__esModule", { value: true });
var obaa_1 = require("./obaa");
var path_1 = require("./path");
function create(store, option) {
    if (arguments.length === 2) {
        if (!store.instances) {
            store.instances = {};
        }
        if (!store.__changes_) {
            store.__changes_ = [];
        }
        var changes_1 = store.__changes_;
        if (!store.onChange) {
            store.onChange = function (fn) {
                changes_1.push(fn);
            };
        }
        if (!store.offChange) {
            store.offChange = function (fn) {
                for (var i = 0, len = changes_1.length; i < len; i++) {
                    if (changes_1[i] === fn) {
                        changes_1.splice(i, 1);
                        break;
                    }
                }
            };
        }
        var hasData_1 = typeof option.data !== 'undefined';
        var clone_1;
        if (option.data) {
            clone_1 = JSON.parse(JSON.stringify(option.data));
            option.data.$ = store.data;
        }
        else {
            option.data = store.data;
        }
        observeStore(store);
        var onLoad_1 = option.onLoad;
        var onUnload_1 = option.onUnload;
        option.onLoad = function (e) {
            this.store = store;
            option.use && (this.__updatePath = path_1.getPath(option.use));
            this.__use = option.use;
            this.__hasData = hasData_1;
            if (hasData_1) {
                Object.assign(option.data, JSON.parse(JSON.stringify(clone_1)));
            }
            store.instances[this.route] = store.instances[this.route] || [];
            store.instances[this.route].push(this);
            this.computed = option.computed;
            this.setData(option.data);
            var using = path_1.getUsing(store.data, option.use);
            option.computed && compute(option.computed, store, using, this);
            this.setData(using);
            onLoad_1 && onLoad_1.call(this, e);
        };
        option.onUnload = function (e) {
            var _this = this;
            store.instances[this.route] = store.instances[this.route].filter(function (ins) { return ins !== _this; });
            onUnload_1 && onUnload_1.call(this, e);
        };
        Page(option);
    }
    else {
        var ready_1 = (store.lifetimes && store.lifetimes.ready) || store.ready;
        store.lifetimes = store.lifetimes || {};
        store.ready = store.lifetimes.ready = function () {
            var page = getCurrentPages()[getCurrentPages().length - 1];
            store.use && (this.__updatePath = path_1.getPath(store.use));
            this.store = page.store;
            this.__use = store.use;
            this.computed = store.computed;
            store.data = this.store.data;
            this.setData(store.data);
            var using = path_1.getUsing(this.store.data, store.use);
            store.computed && compute(store.computed, this.store, using, this);
            this.setData(using);
            this.store.instances[page.route].push(this);
            ready_1 && ready_1.call(this);
        };
        Component(store);
    }
}
function compute(computed, store, using, scope) {
    for (var key in computed) {
        using[key] = computed[key].call(store.data, scope);
    }
}
function observeStore(store) {
    var oba = obaa_1.default(store.data, function (prop, value, old, path) {
        var patch = {};
        if (prop.indexOf('Array-push') === 0) {
            var dl = value.length - old.length;
            for (var i = 0; i < dl; i++) {
                patch[path_1.fixPath(path + '-' + (old.length + i))] = value[(old.length + i)];
            }
        }
        else if (prop.indexOf('Array-') === 0) {
            patch[path_1.fixPath(path)] = value;
        }
        else {
            patch[path_1.fixPath(path + '-' + prop)] = value;
        }
        _update(patch, store);
    });
    if (!store.set) {
        store.set = function (obj, prop, val) {
            obaa_1.default.set(obj, prop, val, oba);
        };
    }
}
function _update(kv, store) {
    for (var key in store.instances) {
        store.instances[key].forEach(function (ins) {
            if (store.updateAll || ins.__updatePath && path_1.needUpdate(kv, ins.__updatePath)) {
                if (ins.__hasData) {
                    var patch = Object.assign({}, kv);
                    for (var pk in patch) {
                        if (!/\$\./.test(pk)) {
                            patch['$.' + pk] = kv[pk];
                            delete patch[pk];
                        }
                    }
                    ins.setData.call(ins, patch);
                }
                else {
                    ins.setData.call(ins, kv);
                }
                var using = path_1.getUsing(store.data, ins.__use);
                compute(ins.computed, store, using, ins);
                ins.setData(using);
            }
        });
    }
    store.__changes_.forEach(function (change) {
        change(kv);
    });
    store.debug && storeChangeLogger(store, kv);
}
function storeChangeLogger(store, diffResult) {
    try {
        var preState = wx.getStorageSync("CurrentState") || {};
        var title = "Data Changed";
        console.groupCollapsed("%c  " + title + " %c " + Object.keys(diffResult), 'color:#e0c184; font-weight: bold', 'color:#f0a139; font-weight: bold');
        console.log("%c    Pre Data", 'color:#ff65af; font-weight: bold', preState);
        console.log("%c Change Data", 'color:#3d91cf; font-weight: bold', diffResult);
        console.log("%c   Next Data", 'color:#2c9f67; font-weight: bold', store.data);
        console.groupEnd();
        wx.setStorageSync("CurrentState", store.data);
    }
    catch (e) {
        console.log(e);
    }
}
create.obaa = obaa_1.default;
exports.default = create;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztFQUlFOztBQUVGLCtCQUF5QjtBQUN6QiwrQkFBK0Q7QUE4Si9ELFNBQVMsTUFBTSxDQUFDLEtBQTRCLEVBQUUsTUFBbUI7SUFDL0QsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNwQixLQUFLLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtTQUNyQjtRQUVELElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3JCLEtBQUssQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFBO1NBQ3RCO1FBRUQsSUFBTSxTQUFPLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtZQUNuQixLQUFLLENBQUMsUUFBUSxHQUFHLFVBQVUsRUFBdUI7Z0JBQ2hELFNBQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDbEIsQ0FBQyxDQUFBO1NBQ0Y7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNwQixLQUFLLENBQUMsU0FBUyxHQUFHLFVBQVUsRUFBdUI7Z0JBQ2pELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxTQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2xELElBQUksU0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTt3QkFDckIsU0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7d0JBQ3BCLE1BQUs7cUJBQ047aUJBQ0Y7WUFDSCxDQUFDLENBQUE7U0FDRjtRQUVELElBQU0sU0FBTyxHQUFHLE9BQU8sTUFBTSxDQUFDLElB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RSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDbEIsRUFBRSxDQUFDLGNBQWMsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO0tBQzlDO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO0tBQ2Y7QUFFSCxDQUFDO0FBRUQsTUFBTSxDQUFDLElBQUksR0FBRyxjQUFJLENBQUE7QUFHbEIsa0JBQWUsTUFBTSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiAgb21peCB2Mi4zLjQgYnkgZG50emhhbmdcbiAqICBHaXRodWI6IGh0dHBzOi8vZ2l0aHViLmNvbS9UZW5jZW50L29taVxuICogIE1JVCBMaWNlbnNlZC5cbiovXG5cbmltcG9ydCBvYmFhIGZyb20gJy4vb2JhYSdcbmltcG9ydCB7IGdldFBhdGgsIG5lZWRVcGRhdGUsIGZpeFBhdGgsIGdldFVzaW5nIH0gZnJvbSAnLi9wYXRoJ1xuXG5cbmludGVyZmFjZSBTdG9yZUNoYW5nZUNhbGxiYWNrIHtcbiAgKGRldGFpbDogYW55KTogdm9pZDtcbn1cblxuaW50ZXJmYWNlIElQYWdlU2Nyb2xsT3B0aW9uIHtcbiAgLyoqIOmhtemdouWcqOWeguebtOaWueWQkeW3sua7muWKqOeahOi3neemu++8iOWNleS9jXB477yJICovXG4gIHNjcm9sbFRvcDogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgSVRhYkl0ZW1UYXBPcHRpb24ge1xuICAvKiog6KKr54K55Ye7dGFiSXRlbeeahOW6j+WPt++8jOS7jjDlvIDlp4vvvIzmnIDkvY7ln7rnoYDlupPvvJogYDEuOS4wYCAqL1xuICBpbmRleDogc3RyaW5nO1xuICAvKiog6KKr54K55Ye7dGFiSXRlbeeahOmhtemdoui3r+W+hO+8jOacgOS9juWfuuehgOW6k++8miBgMS45LjBgICovXG4gIHBhZ2VQYXRoOiBzdHJpbmc7XG4gIC8qKiDooqvngrnlh7t0YWJJdGVt55qE5oyJ6ZKu5paH5a2X77yM5pyA5L2O5Z+656GA5bqT77yaIGAxLjkuMGAgKi9cbiAgdGV4dDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVNoYXJlQXBwTWVzc2FnZU9wdGlvbiB7XG4gIC8qKiDovazlj5Hkuovku7bmnaXmupDjgIJcbiAgICpcbiAgICog5Y+v6YCJ5YC877yaXG4gICAqIC0gYGJ1dHRvbmDvvJrpobXpnaLlhoXovazlj5HmjInpkq7vvJtcbiAgICogLSBgbWVudWDvvJrlj7PkuIrop5Lovazlj5Hoj5zljZXjgIJcbiAgICpcbiAgICog5pyA5L2O5Z+656GA5bqT77yaIGAxLjIuNGBcbiAgICovXG4gIGZyb206ICdidXR0b24nIHwgJ21lbnUnIHwgc3RyaW5nO1xuICAvKiog5aaC5p6cIGBmcm9tYCDlgLzmmK8gYGJ1dHRvbmDvvIzliJkgYHRhcmdldGAg5piv6Kem5Y+R6L+Z5qyh6L2s5Y+R5LqL5Lu255qEIGBidXR0b25g77yM5ZCm5YiZ5Li6IGB1bmRlZmluZWRgXG4gICAqXG4gICAqIOacgOS9juWfuuehgOW6k++8miBgMS4yLjRgICovXG4gIHRhcmdldDogYW55O1xuICAvKiog6aG16Z2i5Lit5YyF5ZCrYDx3ZWItdmlldz5g57uE5Lu25pe277yM6L+U5Zue5b2T5YmNYDx3ZWItdmlldz5g55qEdXJsXG4gICAqXG4gICAqIOacgOS9juWfuuehgOW6k++8miBgMS42LjRgXG4gICAqL1xuICB3ZWJWaWV3VXJsPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSUN1c3RvbVNoYXJlQ29udGVudCB7XG4gIC8qKiDovazlj5HmoIfpopjjgILpu5jorqTlgLzvvJrlvZPliY3lsI/nqIvluo/lkI3np7AgKi9cbiAgdGl0bGU/OiBzdHJpbmc7XG4gIC8qKiDovazlj5Hot6/lvoTvvIzlv4XpobvmmK/ku6UgLyDlvIDlpLTnmoTlrozmlbTot6/lvoTjgILpu5jorqTlgLzvvJrlvZPliY3pobXpnaIgcGF0aCAqL1xuICBwYXRoPzogc3RyaW5nO1xuICAvKiog6Ieq5a6a5LmJ5Zu+54mH6Lev5b6E77yM5Y+v5Lul5piv5pys5Zyw5paH5Lu26Lev5b6E44CB5Luj56CB5YyF5paH5Lu26Lev5b6E5oiW6ICF572R57uc5Zu+54mH6Lev5b6E44CC5pSv5oyBUE5H5Y+KSlBH44CC5pi+56S65Zu+54mH6ZW/5a695q+U5pivIDU6NO+8jOacgOS9juWfuuehgOW6k++8miBgMS41LjBg44CC6buY6K6k5YC877ya5L2/55So6buY6K6k5oiq5Zu+ICovXG4gIGltYWdlVXJsPzogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgQ29tcG9uZW50T3B0aW9uIHtcbiAgW2tleTogc3RyaW5nXTogYW55XG59XG5cbmludGVyZmFjZSBDb21wdXRlZCB7XG4gIFtrZXk6IHN0cmluZ106IGFueVxufVxuXG5pbnRlcmZhY2UgUGFnZU9wdGlvbiB7XG4gIFtrZXk6IHN0cmluZ106IGFueSxcbiAgLyoqXG4gICAqIOS+nei1liBzdG9yZSDkuIrnmoQgcGF0aFxuICAgKi9cbiAgdXNlPzogQXJyYXk8c3RyaW5nIHwgb2JqZWN0PlxuICAvKipcbiAgICog6K6h566X5bGe5oCnXG4gICAqL1xuICBjb21wdXRlZD86IENvbXB1dGVkLFxuICAvKiog55Sf5ZG95ZGo5pyf5Zue6LCD4oCU55uR5ZCs6aG16Z2i5Yqg6L29XG4gICAqXG4gICAqIOmhtemdouWKoOi9veaXtuinpuWPkeOAguS4gOS4qumhtemdouWPquS8muiwg+eUqOS4gOasoe+8jOWPr+S7peWcqCBvbkxvYWQg55qE5Y+C5pWw5Lit6I635Y+W5omT5byA5b2T5YmN6aG16Z2i6Lev5b6E5Lit55qE5Y+C5pWw44CCXG4gICAqL1xuICBvbkxvYWQ/KFxuICAgIC8qKiDmiZPlvIDlvZPliY3pobXpnaLot6/lvoTkuK3nmoTlj4LmlbAgKi9cbiAgICBxdWVyeT86IHsgW3F1ZXJ5S2V5OiBzdHJpbmddOiBzdHJpbmcgfSxcbiAgKTogdm9pZDtcbiAgLyoqIOeUn+WRveWRqOacn+Wbnuiwg+KAlOebkeWQrOmhtemdouaYvuekulxuICAgKlxuICAgKiDpobXpnaLmmL7npLov5YiH5YWl5YmN5Y+w5pe26Kem5Y+R44CCXG4gICAqL1xuICBvblNob3c/KCk6IHZvaWQ7XG4gIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLliJ3mrKHmuLLmn5PlrozmiJBcbiAgICpcbiAgICog6aG16Z2i5Yid5qyh5riy5p+T5a6M5oiQ5pe26Kem5Y+R44CC5LiA5Liq6aG16Z2i5Y+q5Lya6LCD55So5LiA5qyh77yM5Luj6KGo6aG16Z2i5bey57uP5YeG5aSH5aal5b2T77yM5Y+v5Lul5ZKM6KeG5Zu+5bGC6L+b6KGM5Lqk5LqS44CCXG4gICAqXG5cbiAgICog5rOo5oSP77ya5a+555WM6Z2i5YaF5a656L+b6KGM6K6+572u55qEIEFQSSDlpoJgd3guc2V0TmF2aWdhdGlvbkJhclRpdGxlYO+8jOivt+WcqGBvblJlYWR5YOS5i+WQjui/m+ihjOOAglxuICAqL1xuICBvblJlYWR5PygpOiB2b2lkO1xuICAvKiog55Sf5ZG95ZGo5pyf5Zue6LCD4oCU55uR5ZCs6aG16Z2i6ZqQ6JePXG4gICAqXG4gICAqIOmhtemdoumakOiXjy/liIflhaXlkI7lj7Dml7bop6blj5HjgIIg5aaCIGBuYXZpZ2F0ZVRvYCDmiJblupXpg6ggYHRhYmAg5YiH5o2i5Yiw5YW25LuW6aG16Z2i77yM5bCP56iL5bqP5YiH5YWl5ZCO5Y+w562J44CCXG4gICAqL1xuICBvbkhpZGU/KCk6IHZvaWQ7XG4gIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLljbjovb1cbiAgICpcbiAgICog6aG16Z2i5Y246L295pe26Kem5Y+R44CC5aaCYHJlZGlyZWN0VG9g5oiWYG5hdmlnYXRlQmFja2DliLDlhbbku5bpobXpnaLml7bjgIJcbiAgICovXG4gIG9uVW5sb2FkPygpOiB2b2lkO1xuICAvKiog55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXG4gICAqXG4gICAqIOebkeWQrOeUqOaIt+S4i+aLieWIt+aWsOS6i+S7tuOAglxuICAgKiAtIOmcgOimgeWcqGBhcHAuanNvbmDnmoRgd2luZG93YOmAiemhueS4reaIlumhtemdoumFjee9ruS4reW8gOWQr2BlbmFibGVQdWxsRG93blJlZnJlc2hg44CCXG4gICAqIC0g5Y+v5Lul6YCa6L+HYHd4LnN0YXJ0UHVsbERvd25SZWZyZXNoYOinpuWPkeS4i+aLieWIt+aWsO+8jOiwg+eUqOWQjuinpuWPkeS4i+aLieWIt+aWsOWKqOeUu++8jOaViOaenOS4jueUqOaIt+aJi+WKqOS4i+aLieWIt+aWsOS4gOiHtOOAglxuICAgKiAtIOW9k+WkhOeQhuWujOaVsOaNruWIt+aWsOWQju+8jGB3eC5zdG9wUHVsbERvd25SZWZyZXNoYOWPr+S7peWBnOatouW9k+WJjemhtemdoueahOS4i+aLieWIt+aWsOOAglxuICAgKi9cbiAgb25QdWxsRG93blJlZnJlc2g/KCk6IHZvaWQ7XG4gIC8qKiDpobXpnaLkuIrmi4nop6blupXkuovku7bnmoTlpITnkIblh73mlbBcbiAgICpcbiAgICog55uR5ZCs55So5oi35LiK5ouJ6Kem5bqV5LqL5Lu244CCXG4gICAqIC0g5Y+v5Lul5ZyoYGFwcC5qc29uYOeahGB3aW5kb3dg6YCJ6aG55Lit5oiW6aG16Z2i6YWN572u5Lit6K6+572u6Kem5Y+R6Led56a7YG9uUmVhY2hCb3R0b21EaXN0YW5jZWDjgIJcbiAgICogLSDlnKjop6blj5Hot53nprvlhoXmu5HliqjmnJ/pl7TvvIzmnKzkuovku7blj6rkvJrooqvop6blj5HkuIDmrKHjgIJcbiAgICovXG4gIG9uUmVhY2hCb3R0b20/KCk6IHZvaWQ7XG4gIC8qKiDnlKjmiLfngrnlh7vlj7PkuIrop5Lovazlj5FcbiAgICpcbiAgICog55uR5ZCs55So5oi354K55Ye76aG16Z2i5YaF6L2s5Y+R5oyJ6ZKu77yIYDxidXR0b24+YCDnu4Tku7YgYG9wZW4tdHlwZT1cInNoYXJlXCJg77yJ5oiW5Y+z5LiK6KeS6I+c5Y2V4oCc6L2s5Y+R4oCd5oyJ6ZKu55qE6KGM5Li677yM5bm26Ieq5a6a5LmJ6L2s5Y+R5YaF5a6544CCXG4gICAqXG4gICAqICoq5rOo5oSP77ya5Y+q5pyJ5a6a5LmJ5LqG5q2k5LqL5Lu25aSE55CG5Ye95pWw77yM5Y+z5LiK6KeS6I+c5Y2V5omN5Lya5pi+56S64oCc6L2s5Y+R4oCd5oyJ6ZKuKipcbiAgICpcbiAgICog5q2k5LqL5Lu26ZyA6KaBIHJldHVybiDkuIDkuKogT2JqZWN077yM55So5LqO6Ieq5a6a5LmJ6L2s5Y+R5YaF5a65XG4gICAqL1xuICBvblNoYXJlQXBwTWVzc2FnZT8oXG4gICAgLyoqIOWIhuS6q+WPkei1t+adpea6kOWPguaVsCAqL1xuICAgIG9wdGlvbnM/OiBJU2hhcmVBcHBNZXNzYWdlT3B0aW9uLFxuICApOiBJQ3VzdG9tU2hhcmVDb250ZW50O1xuICAvKiog6aG16Z2i5rua5Yqo6Kem5Y+R5LqL5Lu255qE5aSE55CG5Ye95pWwXG4gICAqXG4gICAqIOebkeWQrOeUqOaIt+a7keWKqOmhtemdouS6i+S7tuOAglxuICAgKi9cbiAgb25QYWdlU2Nyb2xsPyhcbiAgICAvKiog6aG16Z2i5rua5Yqo5Y+C5pWwICovXG4gICAgb3B0aW9ucz86IElQYWdlU2Nyb2xsT3B0aW9uLFxuICApOiB2b2lkO1xuXG4gIC8qKiDlvZPliY3mmK8gdGFiIOmhteaXtu+8jOeCueWHuyB0YWIg5pe26Kem5Y+R77yM5pyA5L2O5Z+656GA5bqT77yaIGAxLjkuMGAgKi9cbiAgb25UYWJJdGVtVGFwPyhcbiAgICAvKiogdGFiIOeCueWHu+WPguaVsCAqL1xuICAgIG9wdGlvbnM/OiBJVGFiSXRlbVRhcE9wdGlvbixcbiAgKTogdm9pZDtcblxuICAvKiog56qX5Y+j5bC65a+45pS55Y+Y5pe26Kem5Y+R77yM5pyA5L2O5Z+656GA5bqT77yaYDIuNC4wYCAqL1xuICBvblJlc2l6ZT8oXG4gICAgLyoqIOeql+WPo+WwuuWvuOWPguaVsCAqL1xuICAgIG9wdGlvbnM/OiBJUmVzaXplT3B0aW9uLFxuICApOiB2b2lkO1xufVxuXG5pbnRlcmZhY2UgSVJlc2l6ZU9wdGlvbiB7XG4gIHNpemU6IHtcbiAgICAvKiog5Y+Y5YyW5ZCO55qE56qX5Y+j5a695bqm77yM5Y2V5L2NIHB4ICovXG4gICAgd2luZG93V2lkdGg6IG51bWJlcjtcbiAgICAvKiog5Y+Y5YyW5ZCO55qE56qX5Y+j6auY5bqm77yM5Y2V5L2NIHB4ICovXG4gICAgd2luZG93SGVpZ2h0OiBudW1iZXI7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZShzdG9yZTogYW55IHwgQ29tcG9uZW50T3B0aW9uLCBvcHRpb24/OiBQYWdlT3B0aW9uKSB7XG4gIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgaWYgKCFzdG9yZS5pbnN0YW5jZXMpIHtcbiAgICAgIHN0b3JlLmluc3RhbmNlcyA9IHt9XG4gICAgfVxuXG4gICAgaWYgKCFzdG9yZS5fX2NoYW5nZXNfKSB7XG4gICAgICBzdG9yZS5fX2NoYW5nZXNfID0gW11cbiAgICB9XG5cbiAgICBjb25zdCBjaGFuZ2VzID0gc3RvcmUuX19jaGFuZ2VzX1xuICAgIGlmICghc3RvcmUub25DaGFuZ2UpIHtcbiAgICAgIHN0b3JlLm9uQ2hhbmdlID0gZnVuY3Rpb24gKGZuOiBTdG9yZUNoYW5nZUNhbGxiYWNrKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaChmbilcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXN0b3JlLm9mZkNoYW5nZSkge1xuICAgICAgc3RvcmUub2ZmQ2hhbmdlID0gZnVuY3Rpb24gKGZuOiBTdG9yZUNoYW5nZUNhbGxiYWNrKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgaWYgKGNoYW5nZXNbaV0gPT09IGZuKSB7XG4gICAgICAgICAgICBjaGFuZ2VzLnNwbGljZShpLCAxKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBoYXNEYXRhID0gdHlwZW9mIG9wdGlvbi5kYXRhICE9PSAndW5kZWZpbmVkJ1xuICAgIGxldCBjbG9uZVxuICAgIGlmIChvcHRpb24uZGF0YSkge1xuICAgICAgY2xvbmUgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9wdGlvbi5kYXRhKSlcbiAgICAgIG9wdGlvbi5kYXRhLiQgPSBzdG9yZS5kYXRhXG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdGlvbi5kYXRhID0gc3RvcmUuZGF0YVxuICAgIH1cbiAgICBvYnNlcnZlU3RvcmUoc3RvcmUpXG4gICAgY29uc3Qgb25Mb2FkID0gb3B0aW9uLm9uTG9hZFxuICAgIGNvbnN0IG9uVW5sb2FkID0gb3B0aW9uLm9uVW5sb2FkXG5cbiAgICBvcHRpb24ub25Mb2FkID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZVxuXG4gICAgICBvcHRpb24udXNlICYmICh0aGlzLl9fdXBkYXRlUGF0aCA9IGdldFBhdGgob3B0aW9uLnVzZSkpXG4gICAgICB0aGlzLl9fdXNlID0gb3B0aW9uLnVzZVxuICAgICAgdGhpcy5fX2hhc0RhdGEgPSBoYXNEYXRhXG4gICAgICBpZiAoaGFzRGF0YSkge1xuICAgICAgICBPYmplY3QuYXNzaWduKG9wdGlvbi5kYXRhLCBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGNsb25lKSkpXG4gICAgICB9XG4gICAgICBzdG9yZS5pbnN0YW5jZXNbdGhpcy5yb3V0ZV0gPSBzdG9yZS5pbnN0YW5jZXNbdGhpcy5yb3V0ZV0gfHwgW11cbiAgICAgIHN0b3JlLmluc3RhbmNlc1t0aGlzLnJvdXRlXS5wdXNoKHRoaXMpXG4gICAgICB0aGlzLmNvbXB1dGVkID0gb3B0aW9uLmNvbXB1dGVkXG4gICAgICB0aGlzLnNldERhdGEob3B0aW9uLmRhdGEpXG4gICAgICBjb25zdCB1c2luZyA9IGdldFVzaW5nKHN0b3JlLmRhdGEsIG9wdGlvbi51c2UpXG5cbiAgICAgIG9wdGlvbi5jb21wdXRlZCAmJiBjb21wdXRlKG9wdGlvbi5jb21wdXRlZCwgc3RvcmUsIHVzaW5nLCB0aGlzKVxuICAgICAgdGhpcy5zZXREYXRhKHVzaW5nKVxuXG4gICAgICBvbkxvYWQgJiYgb25Mb2FkLmNhbGwodGhpcywgZSlcbiAgICB9XG5cbiAgICBvcHRpb24ub25VbmxvYWQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgc3RvcmUuaW5zdGFuY2VzW3RoaXMucm91dGVdID0gc3RvcmUuaW5zdGFuY2VzW3RoaXMucm91dGVdLmZpbHRlcihpbnMgPT4gaW5zICE9PSB0aGlzKVxuICAgICAgb25VbmxvYWQgJiYgb25VbmxvYWQuY2FsbCh0aGlzLCBlKVxuICAgIH1cblxuICAgIFBhZ2Uob3B0aW9uKVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IHJlYWR5ID0gKHN0b3JlLmxpZmV0aW1lcyAmJiBzdG9yZS5saWZldGltZXMucmVhZHkpIHx8IHN0b3JlLnJlYWR5XG4gICAgc3RvcmUubGlmZXRpbWVzID0gc3RvcmUubGlmZXRpbWVzIHx8IHt9XG4gICAgc3RvcmUucmVhZHkgPSBzdG9yZS5saWZldGltZXMucmVhZHkgPSBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBwYWdlID0gZ2V0Q3VycmVudFBhZ2VzKClbZ2V0Q3VycmVudFBhZ2VzKCkubGVuZ3RoIC0gMV1cbiAgICAgIHN0b3JlLnVzZSAmJiAodGhpcy5fX3VwZGF0ZVBhdGggPSBnZXRQYXRoKHN0b3JlLnVzZSkpXG4gICAgICB0aGlzLnN0b3JlID0gcGFnZS5zdG9yZVxuICAgICAgdGhpcy5fX3VzZSA9IHN0b3JlLnVzZVxuICAgICAgdGhpcy5jb21wdXRlZCA9IHN0b3JlLmNvbXB1dGVkXG4gICAgICBzdG9yZS5kYXRhID0gdGhpcy5zdG9yZS5kYXRhXG4gICAgICB0aGlzLnNldERhdGEoc3RvcmUuZGF0YSlcbiAgICAgIGNvbnN0IHVzaW5nID0gZ2V0VXNpbmcodGhpcy5zdG9yZS5kYXRhLCBzdG9yZS51c2UpXG5cbiAgICAgIHN0b3JlLmNvbXB1dGVkICYmIGNvbXB1dGUoc3RvcmUuY29tcHV0ZWQsIHRoaXMuc3RvcmUsIHVzaW5nLCB0aGlzKVxuICAgICAgdGhpcy5zZXREYXRhKHVzaW5nKVxuXG4gICAgICB0aGlzLnN0b3JlLmluc3RhbmNlc1twYWdlLnJvdXRlXS5wdXNoKHRoaXMpXG4gICAgICByZWFkeSAmJiByZWFkeS5jYWxsKHRoaXMpXG4gICAgfVxuICAgIENvbXBvbmVudChzdG9yZSlcbiAgfVxufVxuXG5mdW5jdGlvbiBjb21wdXRlKGNvbXB1dGVkLCBzdG9yZSwgdXNpbmcsIHNjb3BlKSB7XG4gIGZvciAobGV0IGtleSBpbiBjb21wdXRlZCkge1xuICAgIHVzaW5nW2tleV0gPSBjb21wdXRlZFtrZXldLmNhbGwoc3RvcmUuZGF0YSwgc2NvcGUpXG4gIH1cbn1cblxuZnVuY3Rpb24gb2JzZXJ2ZVN0b3JlKHN0b3JlKSB7XG4gIGNvbnN0IG9iYSA9IG9iYWEoc3RvcmUuZGF0YSwgKHByb3AsIHZhbHVlLCBvbGQsIHBhdGgpID0+IHtcbiAgICBsZXQgcGF0Y2ggPSB7fVxuICAgIGlmIChwcm9wLmluZGV4T2YoJ0FycmF5LXB1c2gnKSA9PT0gMCkge1xuICAgICAgbGV0IGRsID0gdmFsdWUubGVuZ3RoIC0gb2xkLmxlbmd0aFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkbDsgaSsrKSB7XG4gICAgICAgIHBhdGNoW2ZpeFBhdGgocGF0aCArICctJyArIChvbGQubGVuZ3RoICsgaSkpXSA9IHZhbHVlWyhvbGQubGVuZ3RoICsgaSldXG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm9wLmluZGV4T2YoJ0FycmF5LScpID09PSAwKSB7XG4gICAgICBwYXRjaFtmaXhQYXRoKHBhdGgpXSA9IHZhbHVlXG4gICAgfSBlbHNlIHtcbiAgICAgIHBhdGNoW2ZpeFBhdGgocGF0aCArICctJyArIHByb3ApXSA9IHZhbHVlXG4gICAgfVxuXG4gICAgX3VwZGF0ZShwYXRjaCwgc3RvcmUpXG5cblxuICB9KVxuXG4gIGlmICghc3RvcmUuc2V0KSB7XG4gICAgc3RvcmUuc2V0ID0gZnVuY3Rpb24gKG9iaiwgcHJvcCwgdmFsKSB7XG4gICAgICBvYmFhLnNldChvYmosIHByb3AsIHZhbCwgb2JhKVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBfdXBkYXRlKGt2LCBzdG9yZSkge1xuICBmb3IgKGxldCBrZXkgaW4gc3RvcmUuaW5zdGFuY2VzKSB7XG4gICAgc3RvcmUuaW5zdGFuY2VzW2tleV0uZm9yRWFjaChpbnMgPT4ge1xuICAgICAgaWYgKHN0b3JlLnVwZGF0ZUFsbCB8fCBpbnMuX191cGRhdGVQYXRoICYmIG5lZWRVcGRhdGUoa3YsIGlucy5fX3VwZGF0ZVBhdGgpKSB7XG4gICAgICAgIGlmIChpbnMuX19oYXNEYXRhKSB7XG4gICAgICAgICAgY29uc3QgcGF0Y2ggPSBPYmplY3QuYXNzaWduKHt9LCBrdilcbiAgICAgICAgICBmb3IgKGxldCBwayBpbiBwYXRjaCkge1xuICAgICAgICAgICAgaWYgKCEvXFwkXFwuLy50ZXN0KHBrKSkge1xuICAgICAgICAgICAgICBwYXRjaFsnJC4nICsgcGtdID0ga3ZbcGtdXG4gICAgICAgICAgICAgIGRlbGV0ZSBwYXRjaFtwa11cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaW5zLnNldERhdGEuY2FsbChpbnMsIHBhdGNoKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlucy5zZXREYXRhLmNhbGwoaW5zLCBrdilcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHVzaW5nID0gZ2V0VXNpbmcoc3RvcmUuZGF0YSwgaW5zLl9fdXNlKVxuXG4gICAgICAgIGNvbXB1dGUoaW5zLmNvbXB1dGVkLCBzdG9yZSwgdXNpbmcsIGlucylcbiAgICAgICAgaW5zLnNldERhdGEodXNpbmcpXG5cblxuICAgICAgfVxuICAgIH0pXG4gIH1cbiAgc3RvcmUuX19jaGFuZ2VzXy5mb3JFYWNoKGNoYW5nZSA9PiB7XG4gICAgY2hhbmdlKGt2KVxuICB9KVxuICBzdG9yZS5kZWJ1ZyAmJiBzdG9yZUNoYW5nZUxvZ2dlcihzdG9yZSwga3YpXG59XG5cbmZ1bmN0aW9uIHN0b3JlQ2hhbmdlTG9nZ2VyKHN0b3JlLCBkaWZmUmVzdWx0KSB7XG4gIHRyeSB7XG4gICAgY29uc3QgcHJlU3RhdGUgPSB3eC5nZXRTdG9yYWdlU3luYyhgQ3VycmVudFN0YXRlYCkgfHwge31cbiAgICBjb25zdCB0aXRsZSA9IGBEYXRhIENoYW5nZWRgXG4gICAgY29uc29sZS5ncm91cENvbGxhcHNlZChgJWMgICR7dGl0bGV9ICVjICR7T2JqZWN0LmtleXMoZGlmZlJlc3VsdCl9YCwgJ2NvbG9yOiNlMGMxODQ7IGZvbnQtd2VpZ2h0OiBib2xkJywgJ2NvbG9yOiNmMGExMzk7IGZvbnQtd2VpZ2h0OiBib2xkJylcbiAgICBjb25zb2xlLmxvZyhgJWMgICAgUHJlIERhdGFgLCAnY29sb3I6I2ZmNjVhZjsgZm9udC13ZWlnaHQ6IGJvbGQnLCBwcmVTdGF0ZSlcbiAgICBjb25zb2xlLmxvZyhgJWMgQ2hhbmdlIERhdGFgLCAnY29sb3I6IzNkOTFjZjsgZm9udC13ZWlnaHQ6IGJvbGQnLCBkaWZmUmVzdWx0KVxuICAgIGNvbnNvbGUubG9nKGAlYyAgIE5leHQgRGF0YWAsICdjb2xvcjojMmM5ZjY3OyBmb250LXdlaWdodDogYm9sZCcsIHN0b3JlLmRhdGEpXG4gICAgY29uc29sZS5ncm91cEVuZCgpXG4gICAgd3guc2V0U3RvcmFnZVN5bmMoYEN1cnJlbnRTdGF0ZWAsIHN0b3JlLmRhdGEpXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICB9XG5cbn1cblxuY3JlYXRlLm9iYWEgPSBvYmFhXG5cblxuZXhwb3J0IGRlZmF1bHQgY3JlYXRlXG4iXX0=