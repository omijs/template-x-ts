"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function obaa(target, arr, callback) {
    var _observe = function (target, arr, callback) {
        var $observer = this;
        var eventPropArr = [];
        if (obaa.isArray(target)) {
            if (target.length === 0) {
                $observer.track(target);
            }
            $observer.mock(target);
        }
        for (var prop in target) {
            if (target.hasOwnProperty(prop)) {
                if (callback) {
                    if (obaa.isArray(arr) && obaa.isInArray(arr, prop)) {
                        eventPropArr.push(prop);
                        $observer.watch(target, prop);
                    }
                    else if (obaa.isString(arr) && prop == arr) {
                        eventPropArr.push(prop);
                        $observer.watch(target, prop);
                    }
                }
                else {
                    eventPropArr.push(prop);
                    $observer.watch(target, prop);
                }
            }
        }
        $observer.target = target;
        if (!$observer.propertyChangedHandler)
            $observer.propertyChangedHandler = [];
        var propChanged = callback ? callback : arr;
        $observer.propertyChangedHandler.push({
            all: !callback,
            propChanged: propChanged,
            eventPropArr: eventPropArr
        });
    };
    _observe.prototype = {
        onPropertyChanged: function (prop, value, oldValue, target, path) {
            if (value !== oldValue && (!(nan(value) && nan(oldValue))) && this.propertyChangedHandler) {
                var rootName = obaa._getRootName(prop, path);
                for (var i = 0, len = this.propertyChangedHandler.length; i < len; i++) {
                    var handler = this.propertyChangedHandler[i];
                    if (handler.all ||
                        obaa.isInArray(handler.eventPropArr, rootName) ||
                        rootName.indexOf('Array-') === 0) {
                        handler.propChanged.call(this.target, prop, value, oldValue, path);
                    }
                }
            }
            if (prop.indexOf('Array-') !== 0 && typeof value === 'object') {
                this.watch(target, prop, target.$observeProps.$observerPath);
            }
        },
        mock: function (target) {
            var self = this;
            obaa.methods.forEach(function (item) {
                target[item] = function () {
                    var old = Array.prototype.slice.call(this, 0);
                    var result = Array.prototype[item].apply(this, Array.prototype.slice.call(arguments));
                    if (new RegExp('\\b' + item + '\\b').test(obaa.triggerStr)) {
                        for (var cprop in this) {
                            if (this.hasOwnProperty(cprop) &&
                                !obaa.isFunction(this[cprop])) {
                                self.watch(this, cprop, this.$observeProps.$observerPath);
                            }
                        }
                        self.onPropertyChanged('Array-' + item, this, old, this, this.$observeProps.$observerPath);
                    }
                    return result;
                };
                target['pure' + item.substring(0, 1).toUpperCase() + item.substring(1)] = function () {
                    return Array.prototype[item].apply(this, Array.prototype.slice.call(arguments));
                };
            });
        },
        watch: function (target, prop, path) {
            if (prop === '$observeProps' || prop === '$observer')
                return;
            if (obaa.isFunction(target[prop]))
                return;
            if (!target.$observeProps) {
                Object.defineProperty(target, '$observeProps', {
                    configurable: true,
                    enumerable: false,
                    writable: true,
                    value: {}
                });
            }
            if (path !== undefined) {
                target.$observeProps.$observerPath = path;
            }
            else {
                target.$observeProps.$observerPath = '#';
            }
            var self = this;
            var currentValue = (target.$observeProps[prop] = target[prop]);
            Object.defineProperty(target, prop, {
                get: function () {
                    return this.$observeProps[prop];
                },
                set: function (value) {
                    var old = this.$observeProps[prop];
                    this.$observeProps[prop] = value;
                    self.onPropertyChanged(prop, value, old, this, target.$observeProps.$observerPath);
                }
            });
            if (typeof currentValue == 'object') {
                if (obaa.isArray(currentValue)) {
                    this.mock(currentValue);
                    if (currentValue.length === 0) {
                        this.track(currentValue, prop, path);
                    }
                }
                if (currentValue && Object.keys(currentValue).length === 0) {
                    this.track(currentValue, prop, path);
                }
                for (var cprop in currentValue) {
                    if (currentValue.hasOwnProperty(cprop)) {
                        this.watch(currentValue, cprop, target.$observeProps.$observerPath + '-' + prop);
                    }
                }
            }
        },
        track: function (obj, prop, path) {
            if (obj.$observeProps) {
                return;
            }
            Object.defineProperty(obj, '$observeProps', {
                configurable: true,
                enumerable: false,
                writable: true,
                value: {}
            });
            if (path !== undefined) {
                obj.$observeProps.$observerPath = path + '-' + prop;
            }
            else {
                if (prop !== undefined) {
                    obj.$observeProps.$observerPath = '#' + '-' + prop;
                }
                else {
                    obj.$observeProps.$observerPath = '#';
                }
            }
        }
    };
    return new _observe(target, arr, callback);
}
exports.default = obaa;
obaa.methods = [
    'concat',
    'copyWithin',
    'entries',
    'every',
    'fill',
    'filter',
    'find',
    'findIndex',
    'forEach',
    'includes',
    'indexOf',
    'join',
    'keys',
    'lastIndexOf',
    'map',
    'pop',
    'push',
    'reduce',
    'reduceRight',
    'reverse',
    'shift',
    'slice',
    'some',
    'sort',
    'splice',
    'toLocaleString',
    'toString',
    'unshift',
    'values',
    'size'
];
obaa.triggerStr = [
    'concat',
    'copyWithin',
    'fill',
    'pop',
    'push',
    'reverse',
    'shift',
    'sort',
    'splice',
    'unshift',
    'size'
].join(',');
obaa.isArray = function (obj) {
    return Object.prototype.toString.call(obj) === '[object Array]';
};
obaa.isString = function (obj) {
    return typeof obj === 'string';
};
obaa.isInArray = function (arr, item) {
    for (var i = arr.length; --i > -1;) {
        if (item === arr[i])
            return true;
    }
    return false;
};
obaa.isFunction = function (obj) {
    return Object.prototype.toString.call(obj) == '[object Function]';
};
obaa._getRootName = function (prop, path) {
    if (path === '#') {
        return prop;
    }
    return path.split('-')[1];
};
obaa.add = function (obj, prop) {
    var $observer = obj.$observer;
    $observer.watch(obj, prop);
};
obaa.set = function (obj, prop, value, oba) {
    if (obj[prop] === undefined) {
        var $observer = obj.$observer || oba;
        $observer.watch(obj, prop, obj.$observeProps.$observerPath);
    }
    obj[prop] = value;
};
Array.prototype.size = function (length) {
    this.length = length;
};
function nan(value) {
    return typeof value === "number" && isNaN(value);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JhYS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm9iYWEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFNQSxTQUF3QixJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRO0lBQ2hELElBQUksUUFBUSxHQUFHLFVBQVUsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRO1FBRTVDLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQTtRQUNwQixJQUFJLFlBQVksR0FBRyxFQUFFLENBQUE7UUFDckIsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hCLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ3ZCLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUE7YUFDeEI7WUFDRCxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1NBQ3ZCO1FBQ0QsS0FBSyxJQUFJLElBQUksSUFBSSxNQUFNLEVBQUU7WUFDdkIsSUFBSSxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUMvQixJQUFJLFFBQVEsRUFBRTtvQkFDWixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUU7d0JBQ2xELFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7d0JBQ3ZCLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO3FCQUM5Qjt5QkFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLEdBQUcsRUFBRTt3QkFDNUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDdkIsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUE7cUJBQzlCO2lCQUNG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QUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUE7S0FDNUQ7SUFFRCxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFBO0FBRW5CLENBQUMsQ0FBQTtBQUVELEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLFVBQVUsTUFBTTtJQUNyQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtBQUN0QixDQUFDLENBQUE7QUFFRCxTQUFTLEdBQUcsQ0FBQyxLQUFLO0lBQ2hCLE9BQU8sT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNsRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogb2JhYSAxLjAuMFxuICogQnkgZG50emhhbmdcbiAqIEdpdGh1YjogaHR0cHM6Ly9naXRodWIuY29tL1RlbmNlbnQvb21pXG4gKiBNSVQgTGljZW5zZWQuXG4gKi9cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gb2JhYSh0YXJnZXQsIGFyciwgY2FsbGJhY2spIHtcbiAgdmFyIF9vYnNlcnZlID0gZnVuY3Rpb24gKHRhcmdldCwgYXJyLCBjYWxsYmFjaykge1xuICAgIC8vaWYgKCF0YXJnZXQuJG9ic2VydmVyKSB0YXJnZXQuJG9ic2VydmVyID0gdGhpc1xuICAgIHZhciAkb2JzZXJ2ZXIgPSB0aGlzXG4gICAgdmFyIGV2ZW50UHJvcEFyciA9IFtdXG4gICAgaWYgKG9iYWEuaXNBcnJheSh0YXJnZXQpKSB7XG4gICAgICBpZiAodGFyZ2V0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAkb2JzZXJ2ZXIudHJhY2sodGFyZ2V0KVxuICAgICAgfVxuICAgICAgJG9ic2VydmVyLm1vY2sodGFyZ2V0KVxuICAgIH1cbiAgICBmb3IgKHZhciBwcm9wIGluIHRhcmdldCkge1xuICAgICAgaWYgKHRhcmdldC5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICBpZiAob2JhYS5pc0FycmF5KGFycikgJiYgb2JhYS5pc0luQXJyYXkoYXJyLCBwcm9wKSkge1xuICAgICAgICAgICAgZXZlbnRQcm9wQXJyLnB1c2gocHJvcClcbiAgICAgICAgICAgICRvYnNlcnZlci53YXRjaCh0YXJnZXQsIHByb3ApXG4gICAgICAgICAgfSBlbHNlIGlmIChvYmFhLmlzU3RyaW5nKGFycikgJiYgcHJvcCA9PSBhcnIpIHtcbiAgICAgICAgICAgIGV2ZW50UHJvcEFyci5wdXNoKHByb3ApXG4gICAgICAgICAgICAkb2JzZXJ2ZXIud2F0Y2godGFyZ2V0LCBwcm9wKVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBldmVudFByb3BBcnIucHVzaChwcm9wKVxuICAgICAgICAgICRvYnNlcnZlci53YXRjaCh0YXJnZXQsIHByb3ApXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgJG9ic2VydmVyLnRhcmdldCA9IHRhcmdldFxuICAgIGlmICghJG9ic2VydmVyLnByb3BlcnR5Q2hhbmdlZEhhbmRsZXIpXG4gICAgICAkb2JzZXJ2ZXIucHJvcGVydHlDaGFuZ2VkSGFuZGxlciA9IFtdXG4gICAgdmFyIHByb3BDaGFuZ2VkID0gY2FsbGJhY2sgPyBjYWxsYmFjayA6IGFyclxuICAgICRvYnNlcnZlci5wcm9wZXJ0eUNoYW5nZWRIYW5kbGVyLnB1c2goe1xuICAgICAgYWxsOiAhY2FsbGJhY2ssXG4gICAgICBwcm9wQ2hhbmdlZDogcHJvcENoYW5nZWQsXG4gICAgICBldmVudFByb3BBcnI6IGV2ZW50UHJvcEFyclxuICAgIH0pXG4gIH1cbiAgX29ic2VydmUucHJvdG90eXBlID0ge1xuICAgIG9uUHJvcGVydHlDaGFuZ2VkOiBmdW5jdGlvbiAocHJvcCwgdmFsdWUsIG9sZFZhbHVlLCB0YXJnZXQsIHBhdGgpIHtcbiAgICAgIGlmICh2YWx1ZSAhPT0gb2xkVmFsdWUgJiYgKCEobmFuKHZhbHVlKSAmJiBuYW4ob2xkVmFsdWUpKSkgJiYgdGhpcy5wcm9wZXJ0eUNoYW5nZWRIYW5kbGVyKSB7XG4gICAgICAgIHZhciByb290TmFtZSA9IG9iYWEuX2dldFJvb3ROYW1lKHByb3AsIHBhdGgpXG4gICAgICAgIGZvciAoXG4gICAgICAgICAgdmFyIGkgPSAwLCBsZW4gPSB0aGlzLnByb3BlcnR5Q2hhbmdlZEhhbmRsZXIubGVuZ3RoO1xuICAgICAgICAgIGkgPCBsZW47XG4gICAgICAgICAgaSsrXG4gICAgICAgICkge1xuICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5wcm9wZXJ0eUNoYW5nZWRIYW5kbGVyW2ldXG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgaGFuZGxlci5hbGwgfHxcbiAgICAgICAgICAgIG9iYWEuaXNJbkFycmF5KGhhbmRsZXIuZXZlbnRQcm9wQXJyLCByb290TmFtZSkgfHxcbiAgICAgICAgICAgIHJvb3ROYW1lLmluZGV4T2YoJ0FycmF5LScpID09PSAwXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBoYW5kbGVyLnByb3BDaGFuZ2VkLmNhbGwodGhpcy50YXJnZXQsIHByb3AsIHZhbHVlLCBvbGRWYWx1ZSwgcGF0aClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChwcm9wLmluZGV4T2YoJ0FycmF5LScpICE9PSAwICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgdGhpcy53YXRjaCh0YXJnZXQsIHByb3AsIHRhcmdldC4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGgpXG4gICAgICB9XG4gICAgfSxcbiAgICBtb2NrOiBmdW5jdGlvbiAodGFyZ2V0KSB7XG4gICAgICB2YXIgc2VsZiA9IHRoaXNcbiAgICAgIG9iYWEubWV0aG9kcy5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgIHRhcmdldFtpdGVtXSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB2YXIgb2xkID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcywgMClcbiAgICAgICAgICB2YXIgcmVzdWx0ID0gQXJyYXkucHJvdG90eXBlW2l0ZW1dLmFwcGx5KFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cylcbiAgICAgICAgICApXG4gICAgICAgICAgaWYgKG5ldyBSZWdFeHAoJ1xcXFxiJyArIGl0ZW0gKyAnXFxcXGInKS50ZXN0KG9iYWEudHJpZ2dlclN0cikpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGNwcm9wIGluIHRoaXMpIHtcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIHRoaXMuaGFzT3duUHJvcGVydHkoY3Byb3ApICYmXG4gICAgICAgICAgICAgICAgIW9iYWEuaXNGdW5jdGlvbih0aGlzW2Nwcm9wXSlcbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgc2VsZi53YXRjaCh0aGlzLCBjcHJvcCwgdGhpcy4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGgpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vdG9kb1xuICAgICAgICAgICAgc2VsZi5vblByb3BlcnR5Q2hhbmdlZChcbiAgICAgICAgICAgICAgJ0FycmF5LScgKyBpdGVtLFxuICAgICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgICBvbGQsXG4gICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgIHRoaXMuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoXG4gICAgICAgICAgICApXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByZXN1bHRcbiAgICAgICAgfVxuICAgICAgICB0YXJnZXRbXG4gICAgICAgICAgJ3B1cmUnICsgaXRlbS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIGl0ZW0uc3Vic3RyaW5nKDEpXG4gICAgICAgIF0gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZVtpdGVtXS5hcHBseShcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0sXG4gICAgd2F0Y2g6IGZ1bmN0aW9uICh0YXJnZXQsIHByb3AsIHBhdGgpIHtcbiAgICAgIGlmIChwcm9wID09PSAnJG9ic2VydmVQcm9wcycgfHwgcHJvcCA9PT0gJyRvYnNlcnZlcicpIHJldHVyblxuICAgICAgaWYgKG9iYWEuaXNGdW5jdGlvbih0YXJnZXRbcHJvcF0pKSByZXR1cm5cbiAgICAgIGlmICghdGFyZ2V0LiRvYnNlcnZlUHJvcHMpIHtcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgJyRvYnNlcnZlUHJvcHMnLCB7XG4gICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICAgIHZhbHVlOiB7fVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgaWYgKHBhdGggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0YXJnZXQuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoID0gcGF0aFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGFyZ2V0LiRvYnNlcnZlUHJvcHMuJG9ic2VydmVyUGF0aCA9ICcjJ1xuICAgICAgfVxuICAgICAgdmFyIHNlbGYgPSB0aGlzXG4gICAgICB2YXIgY3VycmVudFZhbHVlID0gKHRhcmdldC4kb2JzZXJ2ZVByb3BzW3Byb3BdID0gdGFyZ2V0W3Byb3BdKVxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgcHJvcCwge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy4kb2JzZXJ2ZVByb3BzW3Byb3BdXG4gICAgICAgIH0sXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgdmFyIG9sZCA9IHRoaXMuJG9ic2VydmVQcm9wc1twcm9wXVxuICAgICAgICAgIHRoaXMuJG9ic2VydmVQcm9wc1twcm9wXSA9IHZhbHVlXG4gICAgICAgICAgc2VsZi5vblByb3BlcnR5Q2hhbmdlZChcbiAgICAgICAgICAgIHByb3AsXG4gICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgIG9sZCxcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICB0YXJnZXQuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgaWYgKHR5cGVvZiBjdXJyZW50VmFsdWUgPT0gJ29iamVjdCcpIHtcbiAgICAgICAgaWYgKG9iYWEuaXNBcnJheShjdXJyZW50VmFsdWUpKSB7XG4gICAgICAgICAgdGhpcy5tb2NrKGN1cnJlbnRWYWx1ZSlcbiAgICAgICAgICAvL+S4ujDvvIzlsLHkuI3kvJrov5vkuIvpnaLnmoQgZm9yIOW+queOr++8jOWwseS4jeS8muaJp+ihjOmHjOmdoueahCB3YXRjaO+8jOWwseS4jeS8muaciSAkb2JzZXJ2ZVByb3BzIOWxnuaAp1xuICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLnRyYWNrKGN1cnJlbnRWYWx1ZSwgcHJvcCwgcGF0aClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSAmJiBPYmplY3Qua2V5cyhjdXJyZW50VmFsdWUpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMudHJhY2soY3VycmVudFZhbHVlLCBwcm9wLCBwYXRoKVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGNwcm9wIGluIGN1cnJlbnRWYWx1ZSkge1xuICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUuaGFzT3duUHJvcGVydHkoY3Byb3ApKSB7XG4gICAgICAgICAgICB0aGlzLndhdGNoKFxuICAgICAgICAgICAgICBjdXJyZW50VmFsdWUsXG4gICAgICAgICAgICAgIGNwcm9wLFxuICAgICAgICAgICAgICB0YXJnZXQuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoICsgJy0nICsgcHJvcFxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgdHJhY2s6IGZ1bmN0aW9uKG9iaiwgcHJvcCwgcGF0aCkge1xuICAgICAgaWYgKG9iai4kb2JzZXJ2ZVByb3BzKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgJyRvYnNlcnZlUHJvcHMnLCB7XG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICB2YWx1ZToge31cbiAgICAgIH0pXG4gICAgICBpZiAocGF0aCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG9iai4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGggPSBwYXRoICsgJy0nICsgcHJvcFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHByb3AgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIG9iai4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGggPSAnIycgKyAnLScgKyBwcm9wXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb2JqLiRvYnNlcnZlUHJvcHMuJG9ic2VydmVyUGF0aCA9ICcjJ1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBuZXcgX29ic2VydmUodGFyZ2V0LCBhcnIsIGNhbGxiYWNrKVxufVxuXG5vYmFhLm1ldGhvZHMgPSBbXG4gICdjb25jYXQnLFxuICAnY29weVdpdGhpbicsXG4gICdlbnRyaWVzJyxcbiAgJ2V2ZXJ5JyxcbiAgJ2ZpbGwnLFxuICAnZmlsdGVyJyxcbiAgJ2ZpbmQnLFxuICAnZmluZEluZGV4JyxcbiAgJ2ZvckVhY2gnLFxuICAnaW5jbHVkZXMnLFxuICAnaW5kZXhPZicsXG4gICdqb2luJyxcbiAgJ2tleXMnLFxuICAnbGFzdEluZGV4T2YnLFxuICAnbWFwJyxcbiAgJ3BvcCcsXG4gICdwdXNoJyxcbiAgJ3JlZHVjZScsXG4gICdyZWR1Y2VSaWdodCcsXG4gICdyZXZlcnNlJyxcbiAgJ3NoaWZ0JyxcbiAgJ3NsaWNlJyxcbiAgJ3NvbWUnLFxuICAnc29ydCcsXG4gICdzcGxpY2UnLFxuICAndG9Mb2NhbGVTdHJpbmcnLFxuICAndG9TdHJpbmcnLFxuICAndW5zaGlmdCcsXG4gICd2YWx1ZXMnLFxuICAnc2l6ZSdcbl1cbm9iYWEudHJpZ2dlclN0ciA9IFtcbiAgJ2NvbmNhdCcsXG4gICdjb3B5V2l0aGluJyxcbiAgJ2ZpbGwnLFxuICAncG9wJyxcbiAgJ3B1c2gnLFxuICAncmV2ZXJzZScsXG4gICdzaGlmdCcsXG4gICdzb3J0JyxcbiAgJ3NwbGljZScsXG4gICd1bnNoaWZ0JyxcbiAgJ3NpemUnXG5dLmpvaW4oJywnKVxuXG5vYmFhLmlzQXJyYXkgPSBmdW5jdGlvbiAob2JqKSB7XG4gIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQXJyYXldJ1xufVxuXG5vYmFhLmlzU3RyaW5nID0gZnVuY3Rpb24gKG9iaikge1xuICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ3N0cmluZydcbn1cblxub2JhYS5pc0luQXJyYXkgPSBmdW5jdGlvbiAoYXJyLCBpdGVtKSB7XG4gIGZvciAodmFyIGkgPSBhcnIubGVuZ3RoOyAtLWkgPiAtMTspIHtcbiAgICBpZiAoaXRlbSA9PT0gYXJyW2ldKSByZXR1cm4gdHJ1ZVxuICB9XG4gIHJldHVybiBmYWxzZVxufVxuXG5vYmFhLmlzRnVuY3Rpb24gPSBmdW5jdGlvbiAob2JqKSB7XG4gIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBGdW5jdGlvbl0nXG59XG5cbm9iYWEuX2dldFJvb3ROYW1lID0gZnVuY3Rpb24gKHByb3AsIHBhdGgpIHtcbiAgaWYgKHBhdGggPT09ICcjJykge1xuICAgIHJldHVybiBwcm9wXG4gIH1cbiAgcmV0dXJuIHBhdGguc3BsaXQoJy0nKVsxXVxufVxuXG5vYmFhLmFkZCA9IGZ1bmN0aW9uIChvYmosIHByb3ApIHtcbiAgdmFyICRvYnNlcnZlciA9IG9iai4kb2JzZXJ2ZXJcbiAgJG9ic2VydmVyLndhdGNoKG9iaiwgcHJvcClcbn1cblxub2JhYS5zZXQgPSBmdW5jdGlvbiAob2JqLCBwcm9wLCB2YWx1ZSwgb2JhKSB7XG4gIC8vIGlmIChleGVjKSB7XG4gIC8vICAgb2JqW3Byb3BdID0gdmFsdWVcbiAgLy8gfVxuICBpZiAob2JqW3Byb3BdID09PSB1bmRlZmluZWQpIHtcbiAgICB2YXIgJG9ic2VydmVyID0gb2JqLiRvYnNlcnZlciB8fCBvYmFcbiAgICAkb2JzZXJ2ZXIud2F0Y2gob2JqLCBwcm9wLCBvYmouJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoKVxuICB9XG4gIC8vaWYgKCFleGVjKSB7XG4gIG9ialtwcm9wXSA9IHZhbHVlXG4gIC8vfVxufVxuXG5BcnJheS5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uIChsZW5ndGgpIHtcbiAgdGhpcy5sZW5ndGggPSBsZW5ndGhcbn1cblxuZnVuY3Rpb24gbmFuKHZhbHVlKSB7XG4gIHJldHVybiB0eXBlb2YgdmFsdWUgPT09IFwibnVtYmVyXCIgJiYgaXNOYU4odmFsdWUpXG59XG4iXX0=