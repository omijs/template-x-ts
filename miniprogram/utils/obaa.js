"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var obaa = function (target, arr, callback) {
    var _observe = function (target, arr, callback) {
        var $observer = this;
        var eventPropArr = [];
        if (obaa.isArray(target)) {
            if (target.length === 0) {
                Object.defineProperty(target, '$observeProps', {
                    configurable: true,
                    enumerable: false,
                    writable: true,
                    value: {}
                });
                target.$observeProps.$observerPath = '#';
            }
            $observer.mock(target);
        }
        for (var prop in target) {
            if (target.hasOwnProperty(prop)) {
                if (callback) {
                    if (obaa.isArray(arr) && obaa.isInArray(arr, prop)) {
                        eventPropArr.push(prop);
                        $observer.watch(target, prop);
                    }
                    else if (obaa.isString(arr) && prop == arr) {
                        eventPropArr.push(prop);
                        $observer.watch(target, prop);
                    }
                }
                else {
                    eventPropArr.push(prop);
                    $observer.watch(target, prop);
                }
            }
        }
        $observer.target = target;
        if (!$observer.propertyChangedHandler)
            $observer.propertyChangedHandler = [];
        var propChanged = callback ? callback : arr;
        $observer.propertyChangedHandler.push({
            all: !callback,
            propChanged: propChanged,
            eventPropArr: eventPropArr
        });
    };
    _observe.prototype = {
        onPropertyChanged: function (prop, value, oldValue, target, path) {
            if (value !== oldValue && (!(nan(value) && nan(oldValue))) && this.propertyChangedHandler) {
                var rootName = obaa._getRootName(prop, path);
                for (var i = 0, len = this.propertyChangedHandler.length; i < len; i++) {
                    var handler = this.propertyChangedHandler[i];
                    if (handler.all ||
                        obaa.isInArray(handler.eventPropArr, rootName) ||
                        rootName.indexOf('Array-') === 0) {
                        handler.propChanged.call(this.target, prop, value, oldValue, path);
                    }
                }
            }
            if (prop.indexOf('Array-') !== 0 && typeof value === 'object') {
                this.watch(target, prop, target.$observeProps.$observerPath);
            }
        },
        mock: function (target) {
            var self = this;
            obaa.methods.forEach(function (item) {
                target[item] = function () {
                    var old = Array.prototype.slice.call(this, 0);
                    var result = Array.prototype[item].apply(this, Array.prototype.slice.call(arguments));
                    if (new RegExp('\\b' + item + '\\b').test(obaa.triggerStr)) {
                        for (var cprop in this) {
                            if (this.hasOwnProperty(cprop) &&
                                !obaa.isFunction(this[cprop])) {
                                self.watch(this, cprop, this.$observeProps.$observerPath);
                            }
                        }
                        self.onPropertyChanged('Array-' + item, this, old, this, this.$observeProps.$observerPath);
                    }
                    return result;
                };
                target['pure' + item.substring(0, 1).toUpperCase() + item.substring(1)] = function () {
                    return Array.prototype[item].apply(this, Array.prototype.slice.call(arguments));
                };
            });
        },
        watch: function (target, prop, path) {
            if (prop === '$observeProps' || prop === '$observer')
                return;
            if (obaa.isFunction(target[prop]))
                return;
            if (!target.$observeProps) {
                Object.defineProperty(target, '$observeProps', {
                    configurable: true,
                    enumerable: false,
                    writable: true,
                    value: {}
                });
            }
            if (path !== undefined) {
                target.$observeProps.$observerPath = path;
            }
            else {
                target.$observeProps.$observerPath = '#';
            }
            var self = this;
            var currentValue = (target.$observeProps[prop] = target[prop]);
            Object.defineProperty(target, prop, {
                get: function () {
                    return this.$observeProps[prop];
                },
                set: function (value) {
                    var old = this.$observeProps[prop];
                    this.$observeProps[prop] = value;
                    self.onPropertyChanged(prop, value, old, this, target.$observeProps.$observerPath);
                }
            });
            if (typeof currentValue == 'object') {
                if (obaa.isArray(currentValue)) {
                    this.mock(currentValue);
                    if (currentValue.length === 0) {
                        if (!currentValue.$observeProps) {
                            Object.defineProperty(currentValue, '$observeProps', {
                                configurable: true,
                                enumerable: false,
                                writable: true,
                                value: {}
                            });
                        }
                        if (path !== undefined) {
                            currentValue.$observeProps.$observerPath = path + '-' + prop;
                        }
                        else {
                            currentValue.$observeProps.$observerPath = '#' + '-' + prop;
                        }
                    }
                }
                for (var cprop in currentValue) {
                    if (currentValue.hasOwnProperty(cprop)) {
                        this.watch(currentValue, cprop, target.$observeProps.$observerPath + '-' + prop);
                    }
                }
            }
        }
    };
    return new _observe(target, arr, callback);
};
obaa.methods = [
    'concat',
    'copyWithin',
    'entries',
    'every',
    'fill',
    'filter',
    'find',
    'findIndex',
    'forEach',
    'includes',
    'indexOf',
    'join',
    'keys',
    'lastIndexOf',
    'map',
    'pop',
    'push',
    'reduce',
    'reduceRight',
    'reverse',
    'shift',
    'slice',
    'some',
    'sort',
    'splice',
    'toLocaleString',
    'toString',
    'unshift',
    'values',
    'size'
];
obaa.triggerStr = [
    'concat',
    'copyWithin',
    'fill',
    'pop',
    'push',
    'reverse',
    'shift',
    'sort',
    'splice',
    'unshift',
    'size'
].join(',');
obaa.isArray = function (obj) {
    return Object.prototype.toString.call(obj) === '[object Array]';
};
obaa.isString = function (obj) {
    return typeof obj === 'string';
};
obaa.isInArray = function (arr, item) {
    for (var i = arr.length; --i > -1;) {
        if (item === arr[i])
            return true;
    }
    return false;
};
obaa.isFunction = function (obj) {
    return Object.prototype.toString.call(obj) == '[object Function]';
};
obaa._getRootName = function (prop, path) {
    if (path === '#') {
        return prop;
    }
    return path.split('-')[1];
};
obaa.add = function (obj, prop) {
    var $observer = obj.$observer;
    $observer.watch(obj, prop);
};
obaa.set = function (obj, prop, value, oba) {
    var $observer = obj.$observer || oba;
    $observer.watch(obj, prop, obj.$observeProps.$observerPath);
    obj[prop] = value;
};
Array.prototype.size = function (length) {
    this.length = length;
};
function nan(value) {
    return typeof value === "number" && isNaN(value);
}
exports.default = obaa;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JhYS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm9iYWEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFNRSxJQUFJLElBQUksR0FBRyxVQUFTLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUTtJQUN2QyxJQUFJLFFBQVEsR0FBRyxVQUFTLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUTtRQUUzQyxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUE7UUFDcEIsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFBO1FBQ3JCLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4QixJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUN2QixNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxlQUFlLEVBQUU7b0JBQzdDLFlBQVksRUFBRSxJQUFJO29CQUNsQixVQUFVLEVBQUUsS0FBSztvQkFDakIsUUFBUSxFQUFFLElBQUk7b0JBQ2QsS0FBSyxFQUFFLEVBQUU7aUJBQ1YsQ0FBQyxDQUFBO2dCQUNGLE1BQU0sQ0FBQyxhQUFhLENBQUMsYUFBYSxHQUFHLEdBQUcsQ0FBQTthQUN6QztZQUNELFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDdkI7UUFDRCxLQUFLLElBQUksSUFBSSxJQUFJLE1BQU0sRUFBRTtZQUN2QixJQUFJLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQy9CLElBQUksUUFBUSxFQUFFO29CQUNaLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRTt3QkFDbEQsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDdkIsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUE7cUJBQzlCO3lCQUFNLElBQUksSUFB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QUssUUFBUSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNwRCxDQUFDO0FBR0Qsa0JBQWUsSUFBSSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogb2JhYSAxLjAuMFxuICogQnkgZG50emhhbmdcbiAqIEdpdGh1YjogaHR0cHM6Ly9naXRodWIuY29tL1RlbmNlbnQvb21pXG4gKiBNSVQgTGljZW5zZWQuXG4gKi9cblxuICB2YXIgb2JhYSA9IGZ1bmN0aW9uKHRhcmdldCwgYXJyLCBjYWxsYmFjaykge1xuICAgIHZhciBfb2JzZXJ2ZSA9IGZ1bmN0aW9uKHRhcmdldCwgYXJyLCBjYWxsYmFjaykge1xuICAgICAgLy9pZiAoIXRhcmdldC4kb2JzZXJ2ZXIpIHRhcmdldC4kb2JzZXJ2ZXIgPSB0aGlzXG4gICAgICB2YXIgJG9ic2VydmVyID0gdGhpc1xuICAgICAgdmFyIGV2ZW50UHJvcEFyciA9IFtdXG4gICAgICBpZiAob2JhYS5pc0FycmF5KHRhcmdldCkpIHtcbiAgICAgICAgaWYgKHRhcmdldC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCAnJG9ic2VydmVQcm9wcycsIHtcbiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICAgICAgICB2YWx1ZToge31cbiAgICAgICAgICB9KVxuICAgICAgICAgIHRhcmdldC4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGggPSAnIydcbiAgICAgICAgfVxuICAgICAgICAkb2JzZXJ2ZXIubW9jayh0YXJnZXQpXG4gICAgICB9XG4gICAgICBmb3IgKHZhciBwcm9wIGluIHRhcmdldCkge1xuICAgICAgICBpZiAodGFyZ2V0Lmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZiAob2JhYS5pc0FycmF5KGFycikgJiYgb2JhYS5pc0luQXJyYXkoYXJyLCBwcm9wKSkge1xuICAgICAgICAgICAgICBldmVudFByb3BBcnIucHVzaChwcm9wKVxuICAgICAgICAgICAgICAkb2JzZXJ2ZXIud2F0Y2godGFyZ2V0LCBwcm9wKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChvYmFhLmlzU3RyaW5nKGFycikgJiYgcHJvcCA9PSBhcnIpIHtcbiAgICAgICAgICAgICAgZXZlbnRQcm9wQXJyLnB1c2gocHJvcClcbiAgICAgICAgICAgICAgJG9ic2VydmVyLndhdGNoKHRhcmdldCwgcHJvcClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZXZlbnRQcm9wQXJyLnB1c2gocHJvcClcbiAgICAgICAgICAgICRvYnNlcnZlci53YXRjaCh0YXJnZXQsIHByb3ApXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICAkb2JzZXJ2ZXIudGFyZ2V0ID0gdGFyZ2V0XG4gICAgICBpZiAoISRvYnNlcnZlci5wcm9wZXJ0eUNoYW5nZWRIYW5kbGVyKVxuICAgICAgICAkb2JzZXJ2ZXIucHJvcGVydHlDaGFuZ2VkSGFuZGxlciA9IFtdXG4gICAgICB2YXIgcHJvcENoYW5nZWQgPSBjYWxsYmFjayA/IGNhbGxiYWNrIDogYXJyXG4gICAgICAkb2JzZXJ2ZXIucHJvcGVydHlDaGFuZ2VkSGFuZGxlci5wdXNoKHtcbiAgICAgICAgYWxsOiAhY2FsbGJhY2ssXG4gICAgICAgIHByb3BDaGFuZ2VkOiBwcm9wQ2hhbmdlZCxcbiAgICAgICAgZXZlbnRQcm9wQXJyOiBldmVudFByb3BBcnJcbiAgICAgIH0pXG4gICAgfVxuICAgIF9vYnNlcnZlLnByb3RvdHlwZSA9IHtcbiAgICAgIG9uUHJvcGVydHlDaGFuZ2VkOiBmdW5jdGlvbihwcm9wLCB2YWx1ZSwgb2xkVmFsdWUsIHRhcmdldCwgcGF0aCkge1xuICAgICAgICBpZiAodmFsdWUgIT09IG9sZFZhbHVlICYmICghKG5hbih2YWx1ZSkgJiYgbmFuKG9sZFZhbHVlKSkpICYmIHRoaXMucHJvcGVydHlDaGFuZ2VkSGFuZGxlcikge1xuICAgICAgICAgIHZhciByb290TmFtZSA9IG9iYWEuX2dldFJvb3ROYW1lKHByb3AsIHBhdGgpXG4gICAgICAgICAgZm9yIChcbiAgICAgICAgICAgIHZhciBpID0gMCwgbGVuID0gdGhpcy5wcm9wZXJ0eUNoYW5nZWRIYW5kbGVyLmxlbmd0aDtcbiAgICAgICAgICAgIGkgPCBsZW47XG4gICAgICAgICAgICBpKytcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5wcm9wZXJ0eUNoYW5nZWRIYW5kbGVyW2ldXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIGhhbmRsZXIuYWxsIHx8XG4gICAgICAgICAgICAgIG9iYWEuaXNJbkFycmF5KGhhbmRsZXIuZXZlbnRQcm9wQXJyLCByb290TmFtZSkgfHxcbiAgICAgICAgICAgICAgcm9vdE5hbWUuaW5kZXhPZignQXJyYXktJykgPT09IDBcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICBoYW5kbGVyLnByb3BDaGFuZ2VkLmNhbGwodGhpcy50YXJnZXQsIHByb3AsIHZhbHVlLCBvbGRWYWx1ZSwgcGF0aClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3AuaW5kZXhPZignQXJyYXktJykgIT09IDAgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgIHRoaXMud2F0Y2godGFyZ2V0LCBwcm9wLCB0YXJnZXQuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgbW9jazogZnVuY3Rpb24odGFyZ2V0KSB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpc1xuICAgICAgICBvYmFhLm1ldGhvZHMuZm9yRWFjaChmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgdGFyZ2V0W2l0ZW1dID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB2YXIgb2xkID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcywgMClcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBBcnJheS5wcm90b3R5cGVbaXRlbV0uYXBwbHkoXG4gICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cylcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIGlmIChuZXcgUmVnRXhwKCdcXFxcYicgKyBpdGVtICsgJ1xcXFxiJykudGVzdChvYmFhLnRyaWdnZXJTdHIpKSB7XG4gICAgICAgICAgICAgIGZvciAodmFyIGNwcm9wIGluIHRoaXMpIHtcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICB0aGlzLmhhc093blByb3BlcnR5KGNwcm9wKSAmJlxuICAgICAgICAgICAgICAgICAgIW9iYWEuaXNGdW5jdGlvbih0aGlzW2Nwcm9wXSlcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgIHNlbGYud2F0Y2godGhpcywgY3Byb3AsIHRoaXMuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAvL3RvZG9cbiAgICAgICAgICAgICAgc2VsZi5vblByb3BlcnR5Q2hhbmdlZChcbiAgICAgICAgICAgICAgICAnQXJyYXktJyArIGl0ZW0sXG4gICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICBvbGQsXG4gICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICB0aGlzLiRvYnNlcnZlUHJvcHMuJG9ic2VydmVyUGF0aFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgICAgfVxuICAgICAgICAgIHRhcmdldFtcbiAgICAgICAgICAgICdwdXJlJyArIGl0ZW0uc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBpdGVtLnN1YnN0cmluZygxKVxuICAgICAgICAgIF0gPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGVbaXRlbV0uYXBwbHkoXG4gICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cylcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9LFxuICAgICAgd2F0Y2g6IGZ1bmN0aW9uKHRhcmdldCwgcHJvcCwgcGF0aCkge1xuICAgICAgICBpZiAocHJvcCA9PT0gJyRvYnNlcnZlUHJvcHMnIHx8IHByb3AgPT09ICckb2JzZXJ2ZXInKSByZXR1cm5cbiAgICAgICAgaWYgKG9iYWEuaXNGdW5jdGlvbih0YXJnZXRbcHJvcF0pKSByZXR1cm5cbiAgICAgICAgaWYgKCF0YXJnZXQuJG9ic2VydmVQcm9wcyl7XG4gICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgJyRvYnNlcnZlUHJvcHMnLCB7XG4gICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICAgICAgdmFsdWU6IHt9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgICBpZiAocGF0aCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdGFyZ2V0LiRvYnNlcnZlUHJvcHMuJG9ic2VydmVyUGF0aCA9IHBhdGhcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0YXJnZXQuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoID0gJyMnXG4gICAgICAgIH1cbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzXG4gICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSAodGFyZ2V0LiRvYnNlcnZlUHJvcHNbcHJvcF0gPSB0YXJnZXRbcHJvcF0pXG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIHByb3AsIHtcbiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuJG9ic2VydmVQcm9wc1twcm9wXVxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICAgICAgdmFyIG9sZCA9IHRoaXMuJG9ic2VydmVQcm9wc1twcm9wXVxuICAgICAgICAgICAgdGhpcy4kb2JzZXJ2ZVByb3BzW3Byb3BdID0gdmFsdWVcbiAgICAgICAgICAgIHNlbGYub25Qcm9wZXJ0eUNoYW5nZWQoXG4gICAgICAgICAgICAgIHByb3AsXG4gICAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgICBvbGQsXG4gICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgIHRhcmdldC4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGhcbiAgICAgICAgICAgIClcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIGlmICh0eXBlb2YgY3VycmVudFZhbHVlID09ICdvYmplY3QnKSB7XG4gICAgICAgICAgaWYgKG9iYWEuaXNBcnJheShjdXJyZW50VmFsdWUpKSB7XG4gICAgICAgICAgICB0aGlzLm1vY2soY3VycmVudFZhbHVlKVxuICAgICAgICAgICAgLy/kuLow77yM5bCx5LiN5Lya6L+b5LiL6Z2i55qEIGZvciDlvqrnjq/vvIzlsLHkuI3kvJrmiafooYzph4zpnaLnmoQgd2F0Y2jvvIzlsLHkuI3kvJrmnIkgJG9ic2VydmVQcm9wcyDlsZ7mgKdcbiAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgIGlmICghY3VycmVudFZhbHVlLiRvYnNlcnZlUHJvcHMpe1xuICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdXJyZW50VmFsdWUsICckb2JzZXJ2ZVByb3BzJywge1xuICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiB7fVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHBhdGggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZS4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGggPSBwYXRoICsgJy0nICsgcHJvcFxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZS4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGggPSAnIycgKyAnLScgKyBwcm9wXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgZm9yICh2YXIgY3Byb3AgaW4gY3VycmVudFZhbHVlKSB7XG4gICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlLmhhc093blByb3BlcnR5KGNwcm9wKSkge1xuICAgICAgICAgICAgICB0aGlzLndhdGNoKFxuICAgICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSxcbiAgICAgICAgICAgICAgICBjcHJvcCxcbiAgICAgICAgICAgICAgICB0YXJnZXQuJG9ic2VydmVQcm9wcy4kb2JzZXJ2ZXJQYXRoICsgJy0nICsgcHJvcFxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBuZXcgX29ic2VydmUodGFyZ2V0LCBhcnIsIGNhbGxiYWNrKVxuICB9XG5cbiAgb2JhYS5tZXRob2RzID0gW1xuICAgICdjb25jYXQnLFxuICAgICdjb3B5V2l0aGluJyxcbiAgICAnZW50cmllcycsXG4gICAgJ2V2ZXJ5JyxcbiAgICAnZmlsbCcsXG4gICAgJ2ZpbHRlcicsXG4gICAgJ2ZpbmQnLFxuICAgICdmaW5kSW5kZXgnLFxuICAgICdmb3JFYWNoJyxcbiAgICAnaW5jbHVkZXMnLFxuICAgICdpbmRleE9mJyxcbiAgICAnam9pbicsXG4gICAgJ2tleXMnLFxuICAgICdsYXN0SW5kZXhPZicsXG4gICAgJ21hcCcsXG4gICAgJ3BvcCcsXG4gICAgJ3B1c2gnLFxuICAgICdyZWR1Y2UnLFxuICAgICdyZWR1Y2VSaWdodCcsXG4gICAgJ3JldmVyc2UnLFxuICAgICdzaGlmdCcsXG4gICAgJ3NsaWNlJyxcbiAgICAnc29tZScsXG4gICAgJ3NvcnQnLFxuICAgICdzcGxpY2UnLFxuICAgICd0b0xvY2FsZVN0cmluZycsXG4gICAgJ3RvU3RyaW5nJyxcbiAgICAndW5zaGlmdCcsXG4gICAgJ3ZhbHVlcycsXG4gICAgJ3NpemUnXG4gIF1cbiAgb2JhYS50cmlnZ2VyU3RyID0gW1xuICAgICdjb25jYXQnLFxuICAgICdjb3B5V2l0aGluJyxcbiAgICAnZmlsbCcsXG4gICAgJ3BvcCcsXG4gICAgJ3B1c2gnLFxuICAgICdyZXZlcnNlJyxcbiAgICAnc2hpZnQnLFxuICAgICdzb3J0JyxcbiAgICAnc3BsaWNlJyxcbiAgICAndW5zaGlmdCcsXG4gICAgJ3NpemUnXG4gIF0uam9pbignLCcpXG5cbiAgb2JhYS5pc0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7XG4gICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nXG4gIH1cblxuICBvYmFhLmlzU3RyaW5nID0gZnVuY3Rpb24ob2JqKSB7XG4gICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdzdHJpbmcnXG4gIH1cblxuICBvYmFhLmlzSW5BcnJheSA9IGZ1bmN0aW9uKGFyciwgaXRlbSkge1xuICAgIGZvciAodmFyIGkgPSBhcnIubGVuZ3RoOyAtLWkgPiAtMTsgKSB7XG4gICAgICBpZiAoaXRlbSA9PT0gYXJyW2ldKSByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIG9iYWEuaXNGdW5jdGlvbiA9IGZ1bmN0aW9uKG9iaikge1xuICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PSAnW29iamVjdCBGdW5jdGlvbl0nXG4gIH1cblxuICBvYmFhLl9nZXRSb290TmFtZSA9IGZ1bmN0aW9uKHByb3AsIHBhdGgpIHtcbiAgICBpZiAocGF0aCA9PT0gJyMnKSB7XG4gICAgICByZXR1cm4gcHJvcFxuICAgIH1cbiAgICByZXR1cm4gcGF0aC5zcGxpdCgnLScpWzFdXG4gIH1cblxuICBvYmFhLmFkZCA9IGZ1bmN0aW9uKG9iaiwgcHJvcCkge1xuICAgIHZhciAkb2JzZXJ2ZXIgPSBvYmouJG9ic2VydmVyXG4gICAgJG9ic2VydmVyLndhdGNoKG9iaiwgcHJvcClcbiAgfVxuXG4gIG9iYWEuc2V0ID0gZnVuY3Rpb24ob2JqLCBwcm9wLCB2YWx1ZSwgb2JhKSB7XG4gICAgLy8gaWYgKGV4ZWMpIHtcbiAgICAvLyAgIG9ialtwcm9wXSA9IHZhbHVlXG4gICAgLy8gfVxuICAgIHZhciAkb2JzZXJ2ZXIgPSBvYmouJG9ic2VydmVyIHx8IG9iYVxuICAgICRvYnNlcnZlci53YXRjaChvYmosIHByb3AsIG9iai4kb2JzZXJ2ZVByb3BzLiRvYnNlcnZlclBhdGgpXG4gICAgLy9pZiAoIWV4ZWMpIHtcbiAgICBvYmpbcHJvcF0gPSB2YWx1ZVxuICAgIC8vfVxuICB9XG5cbiAgQXJyYXkucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbihsZW5ndGgpIHtcbiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aFxuICB9XG5cbiAgZnVuY3Rpb24gbmFuKHZhbHVlKSB7XG4gICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSBcIm51bWJlclwiICYmIGlzTmFOKHZhbHVlKVxuICB9XG5cblxuICBleHBvcnQgZGVmYXVsdCBvYmFhXG5cbiJdfQ==